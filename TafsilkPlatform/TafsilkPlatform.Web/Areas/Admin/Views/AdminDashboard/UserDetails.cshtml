@model TafsilkPlatform.Models.Models.User

@{
    ViewData["Title"] = "User Details";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout_v2.cshtml";
}

<div class="page-header">
    <div class="d-flex align-items-center gap-3">
        <a href="@Url.Action("Users", "AdminDashboard")" class="btn btn-sm btn-outline text-secondary">
            <i class="fas fa-arrow-right"></i>
        </a>
        <h1 class="page-title">User Details</h1>
    </div>
    <div class="page-actions">
        @if (Model.Role?.Name != "Admin")
        {
            @if (!Model.IsActive)
            {
                <form method="post" asp-action="ActivateUser" asp-route-id="@Model.Id" class="d-inline">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-user-check me-2"></i>
                        <span>Activate Account</span>
                    </button>
                </form>
            }
            else
            {
                <button class="btn btn-outline text-warning border-warning" onclick="confirmSuspend('@Model.Id', '@Model.Email')">
                    <i class="fas fa-ban me-2"></i>
                    <span>Suspend Account</span>
                </button>
            }
            
            <button class="btn btn-outline text-danger border-danger" onclick="confirmDelete('@Model.Id', '@Model.Email')">
                <i class="fas fa-trash-alt me-2"></i>
                <span>Delete Account</span>
            </button>
        }
    </div>
</div>

<div class="row g-4">
    <!-- Sidebar Info -->
    <div class="col-12 col-lg-4">
        <div class="card mb-4">
            <div class="card-body text-center p-4">
                <div class="avatar bg-surface-3 text-secondary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                     style="width: 96px; height: 96px; font-size: 2.5rem;">
                    @if (Model.TailorProfile?.ProfilePictureData != null)
                    {
                        <img src="@Url.Action("ProfilePicture", "Account", new { id = Model.Id })" 
                             alt="@Model.Email" class="rounded-circle w-100 h-100 object-fit-cover">
                    }
                    else
                    {
                        @(Model.Email?.Substring(0, 1).ToUpper())
                    }
                </div>
                
                <h3 class="h5 font-bold mb-1">
                    @(Model.CustomerProfile?.FullName ?? Model.TailorProfile?.FullName ?? "User")
                </h3>
                <p class="text-secondary text-sm mb-3">@Model.Email</p>
                
                <div class="d-flex justify-content-center gap-2 mb-4">
                    @{
                        var roleClass = Model.Role?.Name switch {
                            "Admin" => "badge-danger",
                            "Tailor" => "badge-info",
                            _ => "badge-primary"
                        };
                        var roleName = Model.Role?.Name switch {
                            "Admin" => "Administrator",
                            "Tailor" => "Tailor",
                            _ => "Customer"
                        };
                    }
                    <span class="badge @roleClass">@roleName</span>
                    
                    @if (Model.IsActive)
                    {
                        <span class="badge badge-success">Active</span>
                    }
                    else
                    {
                        <span class="badge badge-warning">Suspended</span>
                    }
                </div>
                
                <div class="border-top pt-3 text-start">
                    <div class="d-flex justify-content-between py-2 border-bottom border-subtle">
                        <span class="text-secondary text-sm">Joined Date</span>
                        <span class="font-medium text-sm">@Model.CreatedAt.ToString("yyyy/MM/dd")</span>
                    </div>
                    <div class="d-flex justify-content-between py-2 border-bottom border-subtle">
                        <span class="text-secondary text-sm">Last Login</span>
                        <span class="font-medium text-sm">
                            @(Model.LastLoginAt?.ToString("yyyy/MM/dd HH:mm") ?? "-")
                        </span>
                    </div>
                    <div class="d-flex justify-content-between py-2">
                        <span class="text-secondary text-sm">Email Verified</span>
                        <span class="badge @(Model.EmailVerified ? "badge-success" : "badge-secondary")">
                            @(Model.EmailVerified ? "Yes" : "No")
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        @if (Model.UserAddresses.Any())
        {
            <div class="card">
                <div class="card-header border-bottom border-subtle p-3">
                    <h5 class="card-title h6 mb-0">Saved Addresses</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        @foreach (var address in Model.UserAddresses)
                        {
                            <div class="list-group-item p-3 border-subtle">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="font-medium text-sm">@address.Label</span>
                                    @if (address.IsDefault)
                                    {
                                        <span class="badge badge-success text-xs">Default</span>
                                    }
                                </div>
                                <p class="text-secondary text-xs mb-0">@address.Street, @address.City</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
    
    <!-- Main Content -->
    <div class="col-12 col-lg-8">
        <div class="card h-100">
            <div class="card-header border-bottom border-subtle p-0">
                <ul class="nav nav-tabs border-0 px-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active py-3 border-0 border-bottom border-2 border-primary rounded-0" 
                                data-bs-toggle="tab" data-bs-target="#info" type="button">
                            <i class="fas fa-info-circle me-2"></i>
                            Basic Info
                        </button>
                    </li>
                    @if (Model.TailorProfile != null)
                    {
                        <li class="nav-item" role="presentation">
                            <button class="nav-link py-3 border-0 rounded-0" 
                                    data-bs-toggle="tab" data-bs-target="#tailor" type="button">
                                <i class="fas fa-cut me-2"></i>
                                Tailor Profile
                            </button>
                        </li>
                    }
                    <li class="nav-item" role="presentation">
                        <button class="nav-link py-3 border-0 rounded-0" 
                                data-bs-toggle="tab" data-bs-target="#activity" type="button">
                            <i class="fas fa-history me-2"></i>
                            Activity Log
                        </button>
                    </li>
                </ul>
            </div>
            
            <div class="card-body p-4">
                <div class="tab-content">
                    <!-- Basic Info -->
                    <div class="tab-pane fade show active" id="info" role="tabpanel">
                        <h5 class="h6 mb-4 text-secondary text-uppercase text-xs font-bold tracking-wider">Contact Information</h5>
                        <div class="row g-3 mb-5">
                            <div class="col-md-6">
                                <label class="text-secondary text-xs mb-1">Email</label>
                                <div class="font-medium">@Model.Email</div>
                            </div>
                            <div class="col-md-6">
                                <label class="text-secondary text-xs mb-1">Phone Number</label>
                                <div class="font-medium">@(Model.PhoneNumber ?? "-")</div>
                            </div>
                        </div>
                        
                        @if (Model.CustomerProfile != null)
                        {
                            <h5 class="h6 mb-4 text-secondary text-uppercase text-xs font-bold tracking-wider">Personal Information</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="text-secondary text-xs mb-1">Full Name</label>
                                    <div class="font-medium">@(Model.CustomerProfile.FullName ?? "-")</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="text-secondary text-xs mb-1">Date of Birth</label>
                                    <div class="font-medium">@(Model.CustomerProfile.DateOfBirth?.ToString("yyyy/MM/dd") ?? "-")</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="text-secondary text-xs mb-1">Gender</label>
                                    <div class="font-medium">@(Model.CustomerProfile.Gender ?? "-")</div>
                                </div>
                            </div>
                        }
                    </div>
                    
                    <!-- Tailor Profile -->
                    @if (Model.TailorProfile != null)
                    {
                        <div class="tab-pane fade" id="tailor" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="h6 mb-0 text-secondary text-uppercase text-xs font-bold tracking-wider">Workshop Details</h5>
                                
                                @if (!Model.TailorProfile.IsVerified)
                                {
                                    <div class="d-flex gap-2">
                                        <form asp-action="ApproveTailor" asp-route-id="@Model.TailorProfile.Id" method="post">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-success">
                                                <i class="fas fa-check me-1"></i> Verify
                                            </button>
                                        </form>
                                        <form asp-action="RejectTailor" asp-route-id="@Model.TailorProfile.Id" method="post">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="fas fa-times me-1"></i> Reject
                                            </button>
                                        </form>
                                    </div>
                                }
                                else
                                {
                                    <form asp-action="RejectTailor" asp-route-id="@Model.TailorProfile.Id" method="post">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-sm btn-outline-warning">
                                            <i class="fas fa-ban me-1"></i> Revoke Verification
                                        </button>
                                    </form>
                                }
                            </div>
                            
                            <div class="row g-3 mb-5">
                                <div class="col-md-6">
                                    <label class="text-secondary text-xs mb-1">Workshop Name</label>
                                    <div class="font-medium">@(Model.TailorProfile.ShopName ?? "-")</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="text-secondary text-xs mb-1">Experience Years</label>
                                    <div class="font-medium">@(Model.TailorProfile.ExperienceYears?.ToString() ?? "-")</div>
                                </div>
                                <div class="col-md-12">
                                    <label class="text-secondary text-xs mb-1">Address</label>
                                    <div class="font-medium">@(Model.TailorProfile.Address ?? "-"), @(Model.TailorProfile.City ?? "-")</div>
                                </div>
                            </div>
                            
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <div class="card bg-surface-2 border-0 p-3">
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="avatar bg-white text-primary rounded shadow-sm">
                                                <i class="fas fa-cut"></i>
                                            </div>
                                            <div>
                                                <div class="h4 font-bold mb-0">@Model.TailorProfile.TailorServices.Count(s => !s.IsDeleted)</div>
                                                <div class="text-xs text-secondary">Services Count</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-surface-2 border-0 p-3">
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="avatar bg-white text-primary rounded shadow-sm">
                                                <i class="fas fa-images"></i>
                                            </div>
                                            <div>
                                                <div class="h4 font-bold mb-0">@Model.TailorProfile.PortfolioImages.Count(p => !p.IsDeleted)</div>
                                                <div class="text-xs text-secondary">Portfolio Images</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            @if (ViewBag.Orders is List<TafsilkPlatform.Models.Models.Order> orders && orders.Any())
                            {
                                var totalSales = orders.Where(o => o.Status == TafsilkPlatform.Models.Models.OrderStatus.Delivered).Sum(o => o.TotalPrice);
                                var totalCommission = orders.Where(o => o.Status == TafsilkPlatform.Models.Models.OrderStatus.Delivered).Sum(o => o.CommissionAmount);
                                var netEarnings = totalSales - totalCommission;

                                <h5 class="h6 mb-3 text-secondary text-uppercase text-xs font-bold tracking-wider">Financial Summary</h5>
                                <div class="row g-4">
                                    <div class="col-md-4">
                                        <div class="card border border-subtle p-3">
                                            <div class="text-xs text-secondary mb-1">Total Sales</div>
                                            <div class="h5 font-bold mb-0">@totalSales.ToString("N2") EGP</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border border-subtle p-3">
                                            <div class="text-xs text-secondary mb-1">Platform Commission (10%)</div>
                                            <div class="h5 font-bold text-danger mb-0">-@totalCommission.ToString("N2") EGP</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border border-subtle p-3 bg-success-subtle">
                                            <div class="text-xs text-secondary mb-1">Net Earnings</div>
                                            <div class="h5 font-bold text-success mb-0">@netEarnings.ToString("N2") EGP</div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    
                    <!-- Activity Log -->
                    <div class="tab-pane fade" id="activity" role="tabpanel">
                        <div class="text-center py-5 text-secondary">
                            <i class="fas fa-history fa-2x mb-3 opacity-25"></i>
                            <p>Activity log is currently unavailable</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Suspend Confirmation Modal -->
<div class="modal fade" id="suspendModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Suspension</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to suspend user <strong id="suspendUserEmail"></strong>?</p>
                <form method="post" id="suspendForm">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label class="form-label">Suspension Reason</label>
                        <textarea name="reason" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Confirm Suspension</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete user <strong id="deleteUserEmail"></strong>?</p>
                <p class="text-danger small">This action cannot be undone.</p>
                <form method="post" id="deleteForm">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label class="form-label">Deletion Reason</label>
                        <textarea name="reason" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Confirm Deletion</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function confirmSuspend(userId, email) {
        document.getElementById('suspendUserEmail').textContent = email;
        document.getElementById('suspendForm').action = '/Admin/AdminDashboard/SuspendUser/' + userId;
        new bootstrap.Modal(document.getElementById('suspendModal')).show();
    }
    
    function confirmDelete(userId, email) {
        document.getElementById('deleteUserEmail').textContent = email;
        document.getElementById('deleteForm').action = '/Admin/AdminDashboard/DeleteUser/' + userId;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }
    
    // Handle tab styling
    document.querySelectorAll('.nav-link').forEach(tab => {
        tab.addEventListener('show.bs.tab', function (event) {
            document.querySelectorAll('.nav-link').forEach(t => {
                t.classList.remove('border-bottom', 'border-2', 'border-primary');
                t.classList.add('text-secondary');
            });
            event.target.classList.add('border-bottom', 'border-2', 'border-primary');
            event.target.classList.remove('text-secondary');
        });
    });
</script>
}
