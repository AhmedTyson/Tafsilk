@model TafsilkPlatform.Models.ViewModels.Store.ProductListViewModel

@{
    ViewData["Title"] = "Store - Shop Ready-to-Wear Garments | Tafsilk";
    ViewData["Description"] = "Browse our collection of handcrafted ready-to-wear garments by talented tailors. Find unique clothing for men, women, and kids.";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
<style>
    :root {
        --primary-color: #1a1a1a;
        --primary-hover: #333333;
        --accent-color: #c9a227; /* Gold accent */
        --accent-hover: #b08d1e;
        --text-primary: #1a1a1a;
        --text-secondary: #666666;
        --text-light: #999999;
        --text-white: #ffffff;
        --bg-body: #f8f9fa;
        --bg-surface: #ffffff;
        --bg-glass: rgba(255, 255, 255, 0.95);
        --border-color: #e5e5e5;
        --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
        --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        --radius-md: 8px;
        --radius-lg: 16px;
        --radius-xl: 24px;
        --font-main: 'Inter', system-ui, -apple-system, sans-serif;
    }

    body {
        background-color: var(--bg-body);
        font-family: var(--font-main);
        color: var(--text-primary);
    }

    /* Hero Section */
    .store-hero {
        position: relative;
        height: 250px;
        background: linear-gradient(135deg, #1a1a1a 0%, #2c3e50 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        color: white;
        margin-bottom: 40px;
    }

    .store-hero::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px);
        background-size: 20px 20px;
        opacity: 0.3;
    }

    .hero-content {
        position: relative;
        z-index: 1;
        max-width: 800px;
        padding: 0 20px;
    }

    .hero-title {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #fff, #c9a227);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .hero-subtitle {
        font-size: 1.1rem;
        color: rgba(255,255,255,0.8);
    }

    /* Layout */
    .store-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 40px;
        padding-bottom: 80px;
    }

    /* Sidebar */
    .filter-sidebar {
        position: sticky;
        top: 100px;
        height: fit-content;
        background: var(--bg-surface);
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
    }

    .filter-group {
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border-color);
    }

    .filter-group:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .filter-title {
        font-size: 1rem;
        font-weight: 700;
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .filter-option {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        cursor: pointer;
        color: var(--text-secondary);
        transition: color 0.2s;
    }

    .filter-option:hover {
        color: var(--primary-color);
    }

    .filter-option input[type="radio"],
    .filter-option input[type="checkbox"] {
        margin-right: 10px;
        accent-color: var(--accent-color);
    }

    .price-inputs {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .price-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 0.9rem;
    }

    /* Main Content */
    .store-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .search-box {
        position: relative;
        flex: 1;
        max-width: 400px;
    }

    .search-input {
        width: 100%;
        padding: 12px 40px 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 0.95rem;
        transition: all 0.2s;
    }

    .search-input:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.1);
        outline: none;
    }

    .search-icon {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-light);
    }

    .sort-select {
        padding: 10px 36px 10px 16px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        background-color: var(--bg-surface);
        font-size: 0.95rem;
        cursor: pointer;
    }

    /* Product Grid */
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 24px;
    }

    .product-card {
        background: var(--bg-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
        border-color: var(--accent-color);
    }

    .product-image-wrapper {
        position: relative;
        padding-top: 125%; /* 4:5 Aspect Ratio */
        background: #f0f0f0;
        overflow: hidden;
    }

    .product-image {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        object-fit: cover;
        transition: transform 0.5s;
    }

    .product-card:hover .product-image {
        transform: scale(1.05);
    }

    .product-badge {
        position: absolute;
        top: 12px;
        left: 12px;
        background: var(--accent-color);
        color: white;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 700;
        z-index: 2;
    }

    .product-actions-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 20px;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        display: flex;
        gap: 10px;
        transform: translateY(100%);
        transition: transform 0.3s;
        z-index: 2;
    }

    .product-card:hover .product-actions-overlay {
        transform: translateY(0);
    }

    .product-info {
        padding: 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .product-category {
        font-size: 0.8rem;
        color: var(--text-light);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .product-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--text-primary);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .product-price {
        margin-top: auto;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .current-price {
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--primary-color);
    }

    .original-price {
        font-size: 0.9rem;
        color: var(--text-light);
        text-decoration: line-through;
    }

    .tailor-info {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border-color);
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    /* Buttons */
    .store-container .btn {
        padding: 8px 16px;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 0.9rem;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-hover);
    }

    .btn-accent {
        background: var(--accent-color);
        color: white;
    }

    .btn-accent:hover {
        background: var(--accent-hover);
    }

    .btn-glass {
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(4px);
        color: white;
        border: 1px solid rgba(255,255,255,0.3);
    }

    .btn-glass:hover {
        background: rgba(255,255,255,0.3);
    }

    /* Responsive */
    @@media (max-width: 900px) {
        .store-container {
            grid-template-columns: 1fr;
        }
        .filter-sidebar {
            position: static;
            margin-bottom: 30px;
        }
    }
</style>
}

<div class="store-hero">
    <div class="hero-content">
        <h1 class="hero-title">Ready-to-Wear Collection</h1>
        <p class="hero-subtitle">Discover unique, handcrafted garments from our expert tailors</p>
    </div>
</div>

<div class="store-container">
    <!-- Filters -->
    <aside class="filter-sidebar">
        <form id="filterForm" method="get" asp-action="Index" asp-controller="Store" asp-area="Customer">
            <div class="filter-group">
                <div class="filter-title">
                    Category
                    <button type="button" class="btn btn-sm text-muted" onclick="clearFilters('category')">Clear</button>
                </div>
                <div class="filter-options">
                    <label class="filter-option">
                        <input type="radio" name="category" value="" @(string.IsNullOrEmpty(Model.Category) ? "checked" : "") onchange="this.form.submit()">
                        <span>All Categories</span>
                    </label>
                    @foreach (var cat in new[] { "Men", "Women", "Kids", "Accessories", "Thobe", "Abaya", "Suit" })
                    {
                        <label class="filter-option">
                            <input type="radio" name="category" value="@cat" @(Model.Category == cat ? "checked" : "") onchange="this.form.submit()">
                            <span>@cat</span>
                        </label>
                    }
                </div>
            </div>

            <div class="filter-group">
                <div class="filter-title">Price Range</div>
                <div class="price-inputs">
                    <input type="number" name="minPrice" class="price-input" placeholder="Min" value="@Model.MinPrice">
                    <span style="color: var(--text-light);">-</span>
                    <input type="number" name="maxPrice" class="price-input" placeholder="Max" value="@Model.MaxPrice">
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-2">Apply</button>
            </div>
        </form>
    </aside>

    <!-- Product Grid -->
    <main>
        <div class="store-header">
            <div class="search-box">
                <input type="text" form="filterForm" name="search" class="search-input" placeholder="Search products..." value="@Model.SearchQuery">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="color: var(--text-secondary); font-size: 0.9rem;">@Model.TotalCount items</span>
                <select form="filterForm" name="sortBy" class="sort-select" onchange="this.form.submit()">
                    <option value="">Sort by: Newest</option>
                    <option value="price_asc" selected="@(Model.SortBy == "price_asc")">Price: Low to High</option>
                    <option value="price_desc" selected="@(Model.SortBy == "price_desc")">Price: High to Low</option>
                    <option value="name" selected="@(Model.SortBy == "name")">Name A-Z</option>
                </select>
            </div>
        </div>

        @if (Model.Products.Any())
        {
            <div class="products-grid">
                @foreach (var product in Model.Products)
                {
                    <div class="product-card">
                        <div class="product-image-wrapper">
                            <img src="@Url.Action("GetProductImage", "TailorManagement", new { area = "Tailor", id = product.ProductId })" 
                                 alt="@product.Name" 
                                 class="product-image" 
                                 loading="lazy"
                                 onerror="this.src='/images/placeholder-product.jpg'; this.onerror=null;" />
                            
                            @if (product.DiscountedPrice.HasValue && product.DiscountedPrice < product.Price)
                            {
                                <span class="product-badge">SALE</span>
                            }

                            <div class="product-actions-overlay">
                                <a href="@Url.Action("ProductDetails", "Store", new { area = "Customer", id = product.ProductId })" class="btn btn-glass" style="flex: 1;">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                @if (User.Identity.IsAuthenticated && User.IsInRole("Customer"))
                                {
                                    <button type="button" class="btn btn-accent" style="flex: 1;" onclick="addToCart('@product.ProductId')">
                                        <i class="fas fa-shopping-cart"></i> Add
                                    </button>
                                }
                            </div>
                        </div>

                        <div class="product-info">
                            <div class="product-category">@product.Category</div>
                            <h3 class="product-title">
                                <a href="@Url.Action("ProductDetails", "Store", new { area = "Customer", id = product.ProductId })" style="color: inherit; text-decoration: none;">
                                    @product.Name
                                </a>
                            </h3>
                            
                            <div class="product-price">
                                @if (product.DiscountedPrice.HasValue && product.DiscountedPrice < product.Price)
                                {
                                    <span class="current-price">@product.DiscountedPrice.Value.ToString("N0") EGP</span>
                                    <span class="original-price">@product.Price.ToString("N0") EGP</span>
                                }
                                else
                                {
                                    <span class="current-price">@product.Price.ToString("N0") EGP</span>
                                }
                            </div>

                            @if (!string.IsNullOrEmpty(product.TailorName))
                            {
                                <div class="tailor-info">
                                    <i class="fas fa-user-circle"></i>
                                    <span>By @product.TailorName</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Pagination -->
            @if (Model.TotalPages > 1)
            {
                <div style="margin-top: 40px; display: flex; justify-content: center; gap: 8px;">
                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <a href="@Url.Action("Index", new { page = i, category = Model.Category, search = Model.SearchQuery, sortBy = Model.SortBy })"
                           class="btn @(i == Model.PageNumber ? "btn-primary" : "btn-outline-secondary")"
                           style="width: 40px; height: 40px; padding: 0;">
                            @i
                        </a>
                    }
                </div>
            }
        }
        else
        {
            <div style="text-align: center; padding: 60px; background: var(--bg-surface); border-radius: var(--radius-lg); border: 1px dashed var(--border-color);">
                <i class="fas fa-search" style="font-size: 3rem; color: var(--text-light); margin-bottom: 20px;"></i>
                <h3 style="margin-bottom: 10px;">No products found</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Try adjusting your filters or search terms.</p>
                <a href="@Url.Action("Index", "Store", new { area = "Customer" })" class="btn btn-primary">Clear Filters</a>
            </div>
        }
    </main>
</div>

@section Scripts {
    <script>
        function addToCart(productId) {
            const btn = event.target.closest('button');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const formData = new FormData();
            formData.append('ProductId', productId);
            formData.append('Quantity', 1);
            // Add anti-forgery token if present in layout

            fetch('@Url.Action("AddToCart", "Store", new { area = "Customer" })', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                }
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    // Assuming success if no redirect (or handle JSON response)
                    toastr.success('Added to cart');
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                    }, 2000);
                }
            })
            .catch(err => {
                console.error(err);
                toastr.error('Failed to add to cart');
                btn.disabled = false;
                btn.innerHTML = originalContent;
            });
        }

        function clearFilters(type) {
            if (type === 'category') {
                document.querySelector('input[name="category"][value=""]').checked = true;
                document.getElementById('filterForm').submit();
            }
        }
    </script>
}
