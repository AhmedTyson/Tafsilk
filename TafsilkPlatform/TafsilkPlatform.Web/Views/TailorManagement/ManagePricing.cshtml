@model TafsilkPlatform.Web.ViewModels.TailorManagement.ManagePricingViewModel

@{
    ViewData["Title"] = "إدارة الأسعار";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var breadcrumbs = new List<(string Text, string? Url)>
    {
  ("لوحة التحكم", Url.Action("Tailor", "Dashboards")),
    ("الخدمات", Url.Action("ManageServices", "TailorManagement")),
   ("إدارة الأسعار", "")
    };
}

@await Html.PartialAsync("_Breadcrumb", breadcrumbs)

<div class="container-fluid tailor-management-container" dir="rtl">
    <!-- Page Header -->
 <div class="page-header">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
                <h1 class="page-title">
        <i class="fas fa-dollar-sign"></i>
    إدارة الأسعار
  </h1>
    <p class="page-description">تحديث أسعار الخدمات بشكل جماعي</p>
      </div>
      <div class="d-flex gap-2">
    <a asp-action="ManageServices" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-right"></i>
  العودة للخدمات
     </a>
      </div>
        </div>
    </div>

    @if (Model.ServicePrices.Any())
  {
     <form asp-action="UpdatePricing" method="post">
  @Html.AntiForgeryToken()
      
    <!-- Quick Actions Card -->
 <div class="card mb-4">
      <div class="card-header">
       <h5 class="mb-0">
         <i class="fas fa-bolt"></i>
  إجراءات سريعة
    </h5>
   </div>
<div class="card-body">
      <div class="d-flex gap-2 flex-wrap">
    <button type="button" class="btn btn-success" onclick="applyBulkIncrease(10)">
     <i class="fas fa-arrow-up"></i>
  زيادة 10%
    </button>
 <button type="button" class="btn btn-success" onclick="applyBulkIncrease(20)">
 <i class="fas fa-arrow-up"></i>
    زيادة 20%
      </button>
      <button type="button" class="btn btn-warning" onclick="applyBulkDecrease(10)">
  <i class="fas fa-arrow-down"></i>
   تخفيض 10%
       </button>
   <button type="button" class="btn btn-warning" onclick="applyBulkDecrease(20)">
   <i class="fas fa-arrow-down"></i>
    تخفيض 20%
         </button>
 <button type="button" class="btn btn-outline-secondary" onclick="resetAllPrices()">
 <i class="fas fa-undo"></i>
   إعادة تعيين
     </button>
   </div>
</div>
</div>

    <!-- Services Pricing Table -->
 <div class="card">
   <div class="card-header">
         <h5 class="mb-0">
    <i class="fas fa-table"></i>
   أسعار الخدمات
         </h5>
   </div>
       <div class="card-body p-0">
 <div class="table-responsive">
    <table class="table mb-0">
    <thead>
       <tr>
       <th>اسم الخدمة</th>
    <th class="text-center">السعر الحالي</th>
        <th class="text-center">السعر الجديد</th>
    <th class="text-center">التغيير</th>
      </tr>
    </thead>
<tbody>
           @for (int i = 0; i < Model.ServicePrices.Count; i++)
        {
        var service = Model.ServicePrices[i];
<tr>
      <input type="hidden" asp-for="ServicePrices[i].ServiceId" />
     <input type="hidden" asp-for="ServicePrices[i].ServiceName" />
       <input type="hidden" asp-for="ServicePrices[i].CurrentPrice" class="current-price" />
      
     <td><strong>@service.ServiceName</strong></td>
        <td class="text-center">
      <span class="badge badge-secondary">@service.CurrentPrice.ToString("N0") ريال</span>
   </td>
      <td class="text-center">
      <div class="input-group input-group-sm" style="max-width: 200px; margin: 0 auto;">
   <input type="number" 
 class="form-control new-price" 
     asp-for="ServicePrices[i].NewPrice"
         min="1"
     max="999999"
     step="1"
 data-current="@service.CurrentPrice"
       onchange="calculateChange(this)" />
  <span class="input-group-text">ريال</span>
    </div>
  <span asp-validation-for="ServicePrices[i].NewPrice" class="text-danger small"></span>
     </td>
<td class="text-center">
   <span class="change-indicator badge" data-row="@i"></span>
    </td>
     </tr>
            }
  </tbody>
 </table>
     </div>
   </div>
     <div class="card-footer">
  <div class="d-flex justify-content-between align-items-center">
    <div>
   <i class="fas fa-info-circle text-primary"></i>
 <small class="text-muted">سيتم تحديث الأسعار فوراً بعد الحفظ</small>
   </div>
         <button type="submit" class="btn btn-primary">
      <i class="fas fa-save"></i>
          حفظ التغييرات
      </button>
  </div>
   </div>
    </div>
        </form>
 }
    else
    {
  <div class="empty-state">
 <div class="empty-state-icon">
 <i class="fas fa-dollar-sign"></i>
  </div>
  <h4 class="empty-state-title">لا توجد خدمات لإدارة أسعارها</h4>
    <p class="empty-state-description">يجب إضافة خدمات أولاً قبل إدارة الأسعار</p>
            <a asp-action="AddService" class="btn btn-primary btn-lg">
       <i class="fas fa-plus-circle"></i>
   إضافة خدمة جديدة
      </a>
  </div>
    }
</div>

@section Scripts {
<script>
  // Calculate and display price change
 function calculateChange(input) {
   const currentPrice = parseFloat(input.dataset.current);
const newPrice = parseFloat(input.value);
  const row = input.closest('tr');
   const indicator = row.querySelector('.change-indicator');
 
     if (newPrice && currentPrice) {
   const change = ((newPrice - currentPrice) / currentPrice) * 100;
      const changeText = change > 0 ? `+${change.toFixed(1)}%` : `${change.toFixed(1)}%`;
    
          indicator.textContent = change !== 0 ? changeText : 'بدون تغيير';
    indicator.className = 'change-indicator badge ' + 
     (change > 0 ? 'badge-success' : change < 0 ? 'badge-danger' : 'badge-secondary');
          } else {
         indicator.textContent = '';
    indicator.className = 'change-indicator badge';
        }
  }

      // Apply bulk price increase
        function applyBulkIncrease(percentage) {
            document.querySelectorAll('.new-price').forEach(input => {
  const currentPrice = parseFloat(input.dataset.current);
         const newPrice = Math.round(currentPrice * (1 + percentage / 100));
 input.value = newPrice;
  calculateChange(input);
   });
        }

 // Apply bulk price decrease
 function applyBulkDecrease(percentage) {
  document.querySelectorAll('.new-price').forEach(input => {
    const currentPrice = parseFloat(input.dataset.current);
  const newPrice = Math.round(currentPrice * (1 - percentage / 100));
     input.value = Math.max(1, newPrice); // Minimum price is 1
  calculateChange(input);
 });
        }

        // Reset all prices to current
      function resetAllPrices() {
        document.querySelectorAll('.new-price').forEach(input => {
    input.value = input.dataset.current;
   calculateChange(input);
 });
  }

        // Initialize on page load
   document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.new-price').forEach(calculateChange);
        });
    </script>
}
