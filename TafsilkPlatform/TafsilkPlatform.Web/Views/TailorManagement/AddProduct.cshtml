@model TafsilkPlatform.Web.ViewModels.TailorManagement.AddProductViewModel
@{
    ViewData["Title"] = "Add New Product";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var breadcrumbs = new List<(string Text, string? Url)>
    {
        ("Dashboard", Url.Action("Tailor", "Dashboards")),
        ("Manage Products", Url.Action("ManageProducts", "TailorManagement")),
        ("Add Product", "")
    };
}

@await Html.PartialAsync("_Breadcrumb", breadcrumbs)

<div class="container py-4" dir="rtl">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="mb-4">
                <h1 class="h3 mb-2">
                    <i class="fas fa-plus-circle"></i> Add New Product
                </h1>
                <p class="text-muted">Add your product to the store for customers to see</p>
            </div>

            <form asp-action="AddProduct" asp-controller="TailorManagement" method="post" enctype="multipart/form-data" id="productForm">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="TailorId" />

                <!-- Validation Summary -->
                @if (!ViewData.ModelState.IsValid)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <h5 class="alert-heading">
                            <i class="fas fa-exclamation-triangle"></i> Please fix the following errors:
                        </h5>
                        <ul class="mb-0">
                            @foreach (var state in ViewData.ModelState)
                            {
                                foreach (var error in state.Value.Errors)
                                {
                                    <li>@error.ErrorMessage</li>
                                }
                            }
                        </ul>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }
                
                @if (TempData["Error"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-circle"></i> <strong>Error:</strong> @TempData["Error"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }
                
                @if (TempData["Success"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle"></i> <strong>Success:</strong> @TempData["Success"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                <!-- Basic Information -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle"></i> Basic Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label asp-for="Name" class="form-label"></label>
                                <input asp-for="Name" class="form-control" id="Name" />
                                <span asp-validation-for="Name" class="text-danger" data-valmsg-for="Name"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Category" class="form-label"></label>
                                <select asp-for="Category" class="form-select" id="categorySelect">
                                    <option value="">Select Category</option>
                                    @foreach (var category in ViewBag.Categories as List<string>)
                                    {
                                        <option value="@category">@category</option>
                                    }
                                </select>
                                <span asp-validation-for="Category" class="text-danger" data-valmsg-for="Category"></span>
                            </div>

                            <div class="col-12">
                                <label asp-for="Description" class="form-label"></label>
                                <textarea asp-for="Description" class="form-control" id="Description" rows="4"></textarea>
                                <span asp-validation-for="Description" class="text-danger" data-valmsg-for="Description"></span>
                                <small class="text-muted">Detailed description of the product, features, materials, etc.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pricing & Stock -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-tag"></i> Price and Stock
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="Price" class="form-label"></label>
                                <div class="input-group">
                                    <input asp-for="Price" type="number" step="0.01" class="form-control" id="Price" />
                                    <span class="input-group-text">SAR</span>
                                </div>
                                <span asp-validation-for="Price" class="text-danger" data-valmsg-for="Price"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="DiscountedPrice" class="form-label"></label>
                                <div class="input-group">
                                    <input asp-for="DiscountedPrice" type="number" step="0.01" class="form-control" id="DiscountedPrice" />
                                    <span class="input-group-text">SAR</span>
                                </div>
                                <span asp-validation-for="DiscountedPrice" class="text-danger" data-valmsg-for="DiscountedPrice"></span>
                                <small class="text-muted d-block">Leave empty if no discount</small>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="StockQuantity" class="form-label"></label>
                                <input asp-for="StockQuantity" type="number" class="form-control" id="StockQuantity" />
                                <span asp-validation-for="StockQuantity" class="text-danger" data-valmsg-for="StockQuantity"></span>
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input asp-for="IsAvailable" class="form-check-input" type="checkbox" id="IsAvailable" />
                                    <label asp-for="IsAvailable" class="form-check-label"></label>
                                </div>
                                <small class="text-muted d-block">If the product is available for purchase now</small>
                            </div>

                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input asp-for="IsFeatured" class="form-check-input" type="checkbox" id="IsFeatured" />
                                    <label asp-for="IsFeatured" class="form-check-label"></label>
                                </div>
                                <small class="text-muted d-block">Featured products appear on the homepage</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Details -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-th-list"></i> Product Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label asp-for="SubCategory" class="form-label"></label>
                                <select asp-for="SubCategory" class="form-select" id="SubCategory">
                                    <option value="">Select (Optional)</option>
                                    @foreach (var sub in ViewBag.SubCategories as List<string>)
                                    {
                                        <option value="@sub">@sub</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label asp-for="Size" class="form-label"></label>
                                <select asp-for="Size" class="form-select" id="Size">
                                    <option value="">Select (Optional)</option>
                                    @foreach (var size in ViewBag.Sizes as List<string>)
                                    {
                                        <option value="@size">@size</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label asp-for="Color" class="form-label"></label>
                                <input asp-for="Color" class="form-control" placeholder="e.g. White, Black" id="Color" />
                            </div>

                            <div class="col-md-3">
                                <label asp-for="Material" class="form-label"></label>
                                <select asp-for="Material" class="form-select" id="Material">
                                    <option value="">Select (Optional)</option>
                                    @foreach (var material in ViewBag.Materials as List<string>)
                                    {
                                        <option value="@material">@material</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Brand" class="form-label"></label>
                                <input asp-for="Brand" class="form-control" placeholder="Brand Name (Optional)" id="Brand" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Images -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-images"></i> Product Images
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="PrimaryImage" class="form-label"></label>
                                <input asp-for="PrimaryImage" type="file" class="form-control" accept="image/*" id="primaryImageInput" />
                                <span asp-validation-for="PrimaryImage" class="text-danger" data-valmsg-for="PrimaryImage"></span>
                                <small class="text-muted d-block mt-1">Primary Product Image (Required)</small>
                                

                                <div id="primaryImagePreview" class="mt-3" style="display: none;">
                                    <img id="primaryImagePreviewImg" src="" class="img-fluid rounded" style="max-height: 200px;" />
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="AdditionalImages" class="form-label"></label>
                                <input asp-for="AdditionalImages" type="file" class="form-control" accept="image/*" multiple id="additionalImagesInput" />
                                <small class="text-muted d-block mt-1">You can add up to 5 additional images (Optional)</small>
                                
                                <div id="additionalImagesPreview" class="mt-3 row g-2"></div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle"></i>
                            <strong>Image Tips:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Use clear, high-quality images</li>
                                <li>Show product from different angles</li>
                                <li>Max size: 5MB</li>
                                <li>Accepted formats: JPG, PNG, GIF, WEBP</li>
                            </ul>
                        </div>

                        <!-- Compression & Upload Progress -->
                        <div id="imageCompressProgressContainer" class="mt-3" style="display:none;">
                            <div class="d-flex align-items-center mb-2">
                                <strong class="me-2">Compressing/Preparing images...</strong>
                                <div id="compressSpinner" class="spinner-border spinner-border-sm text-primary me-2" role="status" aria-hidden="true"></div>
                                <small id="compressStatusText" class="text-muted">0%</small>
                            </div>
                            <div class="progress" style="height:10px;">
                                <div id="compressProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width:0%"></div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- SEO (Optional) -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-search"></i> SEO
                            <small class="text-white-50">(Optional)</small>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="MetaTitle" class="form-label"></label>
                                <input asp-for="MetaTitle" class="form-control" placeholder="Product name will be used if left empty" id="MetaTitle" />
                                <span asp-validation-for="MetaTitle" class="text-danger" data-valmsg-for="MetaTitle"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="MetaDescription" class="form-label"></label>
                                <textarea asp-for="MetaDescription" class="form-control" rows="3" placeholder="Product description will be used if left empty" id="MetaDescription"></textarea>
                                <span asp-validation-for="MetaDescription" class="text-danger" data-valmsg-for="MetaDescription"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <a href="@Url.Action("ManageProducts")" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="fas fa-save"></i> Save and Publish Product
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        (function ($) {
            'use strict';

            // Constants
            const ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            const MAX_FILE_BYTES = 5 * 1024 * 1024; // 5 MB
            const MAX_ADDITIONAL_IMAGES = 5;
            const MAX_DIMENSION = 1600; // compression downscale target
            const JPEG_QUALITY = 0.78;
            const SMALL_FILE_THRESHOLD = 200 * 1024; // 200KB - skip heavy compression

            // Cached selectors
            const $primaryInput = $('#primaryImageInput');
            const $primaryPreview = $('#primaryImagePreview');
            const $primaryPreviewImg = $('#primaryImagePreviewImg');
            const $additionalInput = $('#additionalImagesInput');
            const $additionalPreview = $('#additionalImagesPreview');
            const $form = $('#productForm');
            const $submitBtn = $('#submitBtn');
            const $progressContainer = $('#imageCompressProgressContainer');
            const $progressBar = $('#compressProgressBar');
            const $progressText = $('#compressStatusText');

            function showToastr(type, message, title) {
                if (typeof toastr === 'undefined') {
                    alert(message);
                    return;
                }
                switch (type) {
                    case 'success': toastr.success(message, title || ''); break;
                    case 'error': toastr.error(message, title || 'Error'); break;
                    case 'warning': toastr.warning(message, title || 'Warning'); break;
                    default: toastr.info(message, title || '');
                }
            }

            function isAllowedImage(file) {
                return file && file.type && ALLOWED_IMAGE_TYPES.includes(file.type);
            }

            function isWithinSize(file) {
                return file && file.size && file.size <= MAX_FILE_BYTES;
            }

            function formatBytes(bytes) {
                if (!bytes) return '0 B';
                const k = 1024, dm = 2, sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            // IMAGE COMPRESSION UTIL
            function compressImageFile(file) {
                return new Promise((resolve, reject) => {
                    try {
                        if (!file || !file.type || !file.type.startsWith('image/')) {
                            return reject(new Error('Not an image'));
                        }

                        // Fast-path for small files
                        if (file.size <= SMALL_FILE_THRESHOLD) {
                            return resolve(file);
                        }

                        const processBitmap = (bitmap, originalName) => {
                            try {
                                const width = bitmap.width || bitmap.naturalWidth || bitmap.__canvas?.width;
                                const height = bitmap.height || bitmap.naturalHeight || bitmap.__canvas?.height;
                                const max = Math.max(width, height);
                                const scale = max > MAX_DIMENSION ? (MAX_DIMENSION / max) : 1;
                                const w = Math.round(width * scale);
                                const h = Math.round(height * scale);

                                const canvas = document.createElement('canvas');
                                canvas.width = w; canvas.height = h;
                                const ctx = canvas.getContext('2d');

                                if (bitmap instanceof HTMLCanvasElement) {
                                    ctx.drawImage(bitmap, 0, 0, w, h);
                                } else {
                                    ctx.drawImage(bitmap, 0, 0, w, h);
                                }

                                canvas.toBlob(function (blob) {
                                    try {
                                        if (!blob) return reject(new Error('Compression failed'));
                                        const name = originalName.replace(/\.[^/.]+$/, '') + '.jpg';
                                        const compressedFile = new File([blob], name, { type: 'image/jpeg' });
                                        resolve(compressedFile);
                                    } catch (err) { reject(err); }
                                }, 'image/jpeg', JPEG_QUALITY);
                            } catch (err) { reject(err); }
                        };

                        if (window.createImageBitmap) {
                            createImageBitmap(file).then(bitmap => {
                                processBitmap(bitmap, file.name);
                                try { if (bitmap && bitmap.close) bitmap.close(); } catch (e) {}
                            }).catch(err => {
                                // fallback to Image
                                const reader = new FileReader();
                                reader.onload = function (ev) {
                                    const img = new Image();
                                    img.onload = function () { processBitmap(img, file.name); };
                                    img.onerror = function (e) { reject(new Error('Image load failed')); };
                                    img.src = ev.target.result;
                                };
                                reader.onerror = function () { reject(new Error('FileReader error')); };
                                reader.readAsDataURL(file);
                            });
                        } else {
                            const reader = new FileReader();
                            reader.onload = function (ev) {
                                const img = new Image();
                                img.onload = function () { processBitmap(img, file.name); };
                                img.onerror = function (e) { reject(new Error('Image load failed')); };
                                img.src = ev.target.result;
                            };
                            reader.onerror = function () { reject(new Error('FileReader error')); };
                            reader.readAsDataURL(file);
                        }
                    } catch (ex) {
                        reject(ex);
                    }
                });
            }

            // Update progress UI
            function setProgress(percent) {
                try {
                    $progressContainer.show();
                    $progressBar.css('width', percent + '%');
                    $progressText.text(Math.round(percent) + '%');
                } catch (e) { console.warn(e); }
            }

            // Compress an array of files sequentially and update progress
            async function compressFilesSequential(files, onProgress) {
                const results = [];
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    try {
                        const compressed = await compressImageFile(file);
                        results.push(compressed);
                    } catch (err) {
                        // On compression error, fallback to original file
                        console.warn('Compression failed for', file.name, err);
                        results.push(file);
                    }
                    const percent = ((i + 1) / files.length) * 100;
                    if (typeof onProgress === 'function') onProgress(percent);
                    setProgress(percent);
                }
                return results;
            }

            // Primary image preview (keep existing behavior)
            $primaryInput.on('change', function () {
                const file = this.files && this.files[0];
                $primaryPreview.hide();
                $primaryPreviewImg.attr('src', '');

                if (!file) return;

                if (!isAllowedImage(file)) {
                    showToastr('error', 'Invalid file type. Please choose an image (JPG, PNG, GIF, WEBP)');
                    $primaryInput.val('');
                    return;
                }

                if (!isWithinSize(file)) {
                    showToastr('error', `Image size too large. Max ${formatBytes(MAX_FILE_BYTES)}`);
                    $primaryInput.val('');
                    return;
                }

                const url = URL.createObjectURL(file);
                $primaryPreviewImg.attr('src', url);
                $primaryPreview.show();
                $primaryPreviewImg.on('load', function () { try { URL.revokeObjectURL(url); } catch (e) {} });
            });

            // Additional images preview (existing behavior)
            $additionalInput.on('change', function () {
                const files = Array.from(this.files || []);
                $additionalPreview.empty();

                if (!files.length) return;

                if (files.length > MAX_ADDITIONAL_IMAGES) {
                    showToastr('warning', `You can add max ${MAX_ADDITIONAL_IMAGES} images. First ${MAX_ADDITIONAL_IMAGES} images will be used.`);
                }

                const allowed = [];
                files.slice(0, MAX_ADDITIONAL_IMAGES).forEach((file, index) => {
                    if (!isAllowedImage(file)) {
                        showToastr('error', `Ignored invalid file: ${file.name}`);
                        return;
                    }
                    if (!isWithinSize(file)) {
                        showToastr('error', `Ignored file too large: ${file.name} (${formatBytes(file.size)})`);
                        return;
                    }
                    allowed.push(file);
                });

                // show previews
                allowed.forEach((file, idx) => {
                    const url = URL.createObjectURL(file);
                    const col = $(`<div class="col-md-3 col-6">
                        <div class="position-relative">
                            <img src="${url}" class="img-fluid rounded shadow-sm" style="height:150px;object-fit:cover;width:100%;" />
                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1 remove-additional" data-index="${idx}"><i class="fas fa-times"></i></button>
                        </div>
                    </div>`);
                    $additionalPreview.append(col);
                    col.find('img').on('load', function () { try { URL.revokeObjectURL(url); } catch (e) {} });
                });
            });

            // Delegate removal clicks for additional images
            $additionalPreview.on('click', '.remove-additional', function () {
                try {
                    const idx = parseInt($(this).attr('data-index'));
                    const input = $additionalInput[0];
                    if (!input || !input.files) return;

                    const files = Array.from(input.files);
                    if (isNaN(idx) || idx < 0 || idx >= files.length) return;

                    files.splice(idx, 1);
                    try {
                        const dt = new DataTransfer();
                        files.forEach(f => dt.items.add(f));
                        input.files = dt.files;
                    } catch (e) { input.value = ''; }

                    // rebuild preview
                    $additionalPreview.empty();
                    Array.from(input.files || []).forEach((file, newIdx) => {
                        const url = URL.createObjectURL(file);
                        const col = $(`<div class="col-md-3 col-6">
                            <div class="position-relative">
                                <img src="${url}" class="img-fluid rounded shadow-sm" style="height:150px;object-fit:cover;width:100%;" />
                                <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1 remove-additional" data-index="${newIdx}"><i class="fas fa-times"></i></button>
                            </div>
                        </div>`);
                        $additionalPreview.append(col);
                        col.find('img').on('load', function () { try { URL.revokeObjectURL(url); } catch (e) {} });
                    });
                } catch (err) { console.error('Error removing additional image', err); }
            });

            // Centralized validation used before compression/submission
            function clearValidationSpans() { $('[data-valmsg-for]').each(function () { $(this).text(''); }); }

            function validateForm() {
                clearValidationSpans();
                const errors = [];

                const name = $('#Name').val() ? $('#Name').val().toString().trim() : '';
                if (!name) { errors.push('Product name is required'); $('[data-valmsg-for="Name"]').text('Product name is required'); }

                const description = $('#Description').val() ? $('#Description').val().toString().trim() : '';
                if (!description) { errors.push('Product description is required'); $('[data-valmsg-for="Description"]').text('Product description is required'); }

                const price = parseFloat($('#Price').val());
                if (isNaN(price) || price <= 0) { errors.push('Price is required and must be greater than zero'); $('[data-valmsg-for="Price"]').text('Price is required and must be greater than zero'); }

                const category = $('#categorySelect').val();
                if (!category) { errors.push('Category is required'); $('[data-valmsg-for="Category"]').text('Category is required'); }

                const stock = parseInt($('#StockQuantity').val());
                if (isNaN(stock) || stock < 0) { errors.push('Stock quantity is required'); $('[data-valmsg-for="StockQuantity"]').text('Stock quantity is required'); }

                const primaryFile = $primaryInput[0] && $primaryInput[0].files ? $primaryInput[0].files[0] : null;
                if (!primaryFile) { errors.push('Primary image is required'); $('[data-valmsg-for="PrimaryImage"]').text('Primary image is required'); }
                else {
                    if (!isAllowedImage(primaryFile)) { errors.push('Invalid image type'); $('[data-valmsg-for="PrimaryImage"]').text('Invalid image type'); }
                    if (!isWithinSize(primaryFile)) { errors.push('Image size too large (more than 5MB)'); $('[data-valmsg-for="PrimaryImage"]').text('Image size too large'); }
                }

                return errors;
            }

            // NEW: Intercept submit to compress images then submit
            $form.on('submit', async function (e) {
                try {
                    if (window.formIsSubmitting) { e.preventDefault(); showToastr('warning', 'Processing request, please wait...'); return false; }

                    const errors = validateForm();
                    if (errors.length) { e.preventDefault(); showToastr('error', 'Please fix errors highlighted in red'); const $first = $('.text-danger').filter(function() { return $(this).text().trim() !== ''; }).first(); if ($first.length && $first.offset()) { $('html, body').animate({ scrollTop: $first.offset().top - 100 }, 400); } return false; }

                    // Start compression process
                    e.preventDefault(); // we'll submit programmatically after compression
                    window.formIsSubmitting = true;
                    $submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');

                    // Build list of files to compress: primary + additional
                    const primaryFile = $primaryInput[0] && $primaryInput[0].files ? $primaryInput[0].files[0] : null;
                    const additionalFiles = $additionalInput[0] && $additionalInput[0].files ? Array.from($additionalInput[0].files) : [];

                    const filesToCompress = [];
                    if (primaryFile) filesToCompress.push({ type: 'primary', file: primaryFile });
                    additionalFiles.slice(0, MAX_ADDITIONAL_IMAGES).forEach(f => filesToCompress.push({ type: 'additional', file: f }));

                    if (filesToCompress.length === 0) {
                        // nothing to compress; submit normally
                        $form.off('submit'); // remove handler to avoid loop
                        $form.submit();
                        return true;
                    }

                    // Show progress
                    setProgress(0);

                    // Compress sequentially and update progress
                    const originalFiles = filesToCompress.map(x => x.file);
                    const compressedFiles = await compressFilesSequential(originalFiles, (p) => setProgress(p));

                    // Reassign compressed files back to inputs
                    try {
                        // primary
                        if (primaryFile) {
                            const compPrimary = compressedFiles.shift();
                            if (compPrimary) {
                                const dt = new DataTransfer();
                                dt.items.add(compPrimary);
                                $primaryInput[0].files = dt.files;

                                // update preview
                                const url = URL.createObjectURL(compPrimary);
                                $primaryPreviewImg.attr('src', url);
                                $primaryPreview.show();
                                $primaryPreviewImg.on('load', function () { try { URL.revokeObjectURL(url); } catch (e) {} });
                            }
                        }

                        // additional
                        const remaining = compressedFiles; // rest are additional
                        if (remaining && remaining.length) {
                            try {
                                const dt2 = new DataTransfer();
                                remaining.forEach(f => dt2.items.add(f));
                                $additionalInput[0].files = dt2.files;
                            } catch (e) {
                                console.warn('DataTransfer not supported, additional input not replaced', e);
                            }

                            // refresh previews
                            $additionalPreview.empty();
                            Array.from($additionalInput[0].files || []).forEach((file, idx) => {
                                const url = URL.createObjectURL(file);
                                const col = $(`<div class="col-md-3 col-6">
                                    <div class="position-relative">
                                        <img src="${url}" class="img-fluid rounded shadow-sm" style="height:150px;object-fit:cover;width:100%;" />
                                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1 remove-additional" data-index="${idx}"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>`);
                                $additionalPreview.append(col);
                                col.find('img').on('load', function () { try { URL.revokeObjectURL(url); } catch (e) {} });
                            });
                        }
                    } catch (err) {
                        console.warn('Error assigning compressed files to inputs', err);
                    }

                    // finalize progress
                    setProgress(100);
                    setTimeout(() => { $progressContainer.fadeOut(400); }, 600);

                    // remove handler and submit
                    $form.off('submit');
                    $form.submit();
                    return true;

                } catch (err) {
                    console.error('Submit/compression error', err);
                    showToastr('error', 'Error preparing images. Trying to submit without compression.');
                    // fallback: submit original files
                    try { $form.off('submit'); $form.submit(); } catch (e) { console.error(e); }
                    return false;
                }
            });

            // Toastr RTL configuration executed once
            if (typeof toastr !== 'undefined') {
                toastr.options = Object.assign({}, toastr.options || {}, {
                    closeButton: true,
                    progressBar: true,
                    positionClass: 'toast-top-left',
                    timeOut: '5000',
                    extendedTimeOut: '2000',
                    showMethod: 'fadeIn',
                    hideMethod: 'fadeOut',
                    rtl: true
                });
            }

            // Show TempData messages via toastr (if present)
            $(function () {
                @if (TempData["Success"] != null) {
                    <text>showToastr('success', '@Html.Raw(TempData["Success"])', 'Success!');</text>
                }
                @if (TempData["Error"] != null) {
                    <text>showToastr('error', '@Html.Raw(TempData["Error"])', 'Error!');</text>
                }
            });

        })(jQuery);
    </script>
}

@section Styles {
    <style>
        .form-control:focus,
        .form-select:focus { border-color: #0d6efd; box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25); }
        .card { border: none; }
        .card-header { border-bottom: 2px solid rgba(255,255,255,0.2); }
        #primaryImagePreview img, #additionalImagesPreview img { object-fit: cover; }
        .form-check-input:checked { background-color: #198754; border-color: #198754; }
    </style>
}
