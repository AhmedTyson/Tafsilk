@model IEnumerable<TafsilkPlatform.Models.Models.User>

@{
    ViewData["Title"] = "إدارة المستخدمين";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
<style>
    :root {
        --primary-blue: #2563eb;
        --success-green: #10b981;
        --danger-red: #ef4444;
        --warning-yellow: #f59e0b;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-600: #6b7280;
        --gray-800: #1f2937;
    }

    .user-management-page {
        padding: 2rem 0;
        background: var(--gray-100);
 min-height: 100vh;
    }

    .page-header {
        background: white;
        border-radius: 12px;
     padding: 2rem;
        margin-bottom: 2rem;
   box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .page-title {
     font-size: 2rem;
        font-weight: 700;
        color: var(--gray-800);
        margin-bottom: 0.5rem;
    }

  .page-subtitle {
        color: var(--gray-600);
        font-size: 1rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
 align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .stat-icon.primary { background: rgba(37, 99, 235, 0.1); color: var(--primary-blue); }
    .stat-icon.success { background: rgba(16, 185, 129, 0.1); color: var(--success-green); }
    .stat-icon.danger { background: rgba(239, 68, 68, 0.1); color: var(--danger-red); }
    .stat-icon.warning { background: rgba(245, 158, 11, 0.1); color: var(--warning-yellow); }

    .stat-content h3 {
        font-size: 2rem;
    font-weight: 700;
        margin: 0;
        color: var(--gray-800);
    }

    .stat-content p {
        margin: 0;
      color: var(--gray-600);
     font-size: 0.875rem;
    }

    .filters-section {
        background: white;
  border-radius: 12px;
        padding: 1.5rem;
  margin-bottom: 2rem;
 box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

    .filters-grid {
    display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
     gap: 1rem;
        align-items: end;
 }

    .filter-group {
        display: flex;
      flex-direction: column;
        gap: 0.5rem;
    }

    .filter-label {
        font-weight: 600;
        color: var(--gray-800);
        font-size: 0.875rem;
    }

    .filter-input,
    .filter-select {
    padding: 0.625rem 1rem;
        border: 1px solid var(--gray-200);
border-radius: 8px;
  font-size: 0.875rem;
        transition: border-color 0.2s;
    }

    .filter-input:focus,
    .filter-select:focus {
    outline: none;
        border-color: var(--primary-blue);
    }

    .btn-filter {
        padding: 0.625rem 1.5rem;
 background: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
     cursor: pointer;
      transition: background 0.2s;
    }

    .btn-filter:hover {
     background: #1e40af;
    }

    .btn-reset {
        padding: 0.625rem 1.5rem;
        background: var(--gray-200);
        color: var(--gray-800);
        border: none;
        border-radius: 8px;
font-weight: 600;
   cursor: pointer;
        transition: background 0.2s;
    }

    .btn-reset:hover {
        background: #d1d5db;
    }

    .users-table-container {
    background: white;
        border-radius: 12px;
     overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .table-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-title {
        font-size: 1.25rem;
        font-weight: 700;
    color: var(--gray-800);
    }

    .users-table {
        width: 100%;
        border-collapse: collapse;
    }

    .users-table thead {
        background: var(--gray-100);
    }

    .users-table th,
    .users-table td {
        padding: 1rem;
        text-align: right;
        border-bottom: 1px solid var(--gray-200);
  }

    .users-table th {
      font-weight: 600;
 color: var(--gray-800);
        font-size: 0.875rem;
  text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .users-table tbody tr {
        transition: background 0.2s;
    }

    .users-table tbody tr:hover {
     background: var(--gray-100);
    }

    .user-info {
    display: flex;
        align-items: center;
        gap: 1rem;
    }

    .user-avatar {
     width: 40px;
     height: 40px;
        border-radius: 50%;
        background: var(--gray-200);
    display: flex;
align-items: center;
        justify-content: center;
        color: var(--gray-600);
        font-weight: 600;
  flex-shrink: 0;
    }

    .user-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .user-details h4 {
        margin: 0;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-800);
    }

    .user-details p {
   margin: 0;
        font-size: 0.75rem;
      color: var(--gray-600);
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
     font-weight: 600;
    }

    .status-badge.online {
        background: rgba(16, 185, 129, 0.1);
 color: var(--success-green);
    }

 .status-badge.offline {
   background: rgba(107, 114, 128, 0.1);
  color: var(--gray-600);
    }

    .status-badge.banned {
     background: rgba(239, 68, 68, 0.1);
        color: var(--danger-red);
    }

  .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
    }

    .role-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
     font-weight: 600;
        text-transform: uppercase;
    }

    .role-badge.customer {
        background: #28a745;
   color: var(--primary-blue);
    }

    .role-badge.tailor {
        background: #17a2b8;
        color: var(--warning-yellow);
    }

    .role-badge.admin {
      background: #dc3545;
        color: var(--danger-red);
 }

    .action-buttons {
    display: flex;
        gap: 0.5rem;
    }

    .btn-action {
        padding: 0.375rem 0.75rem;
        border: none;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }

    .btn-view {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary-blue);
    }

    .btn-view:hover {
        background: rgba(37, 99, 235, 0.2);
    }

    .btn-ban {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-red);
    }

    .btn-ban:hover {
        background: rgba(239, 68, 68, 0.2);
    }

    .btn-unban {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-green);
    }

    .btn-unban:hover {
        background: rgba(16, 185, 129, 0.2);
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
    gap: 0.5rem;
        padding: 1.5rem;
    }

    .pagination-btn {
        padding: 0.5rem 1rem;
        border: 1px solid var(--gray-200);
        background: white;
        color: var(--gray-800);
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .pagination-btn:hover {
    background: var(--gray-100);
    }

    .pagination-btn.active {
   background: var(--primary-blue);
    color: white;
     border-color: var(--primary-blue);
    }

 .pagination-btn:disabled {
   opacity: 0.5;
   cursor: not-allowed;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--gray-600);
    }

    .empty-state i {
      font-size: 4rem;
        color: var(--gray-200);
     margin-bottom: 1rem;
    }

 @@media (max-width: 768px) {
    .stats-grid {
    grid-template-columns: 1fr;
   }

        .filters-grid {
            grid-template-columns: 1fr;
        }

        .users-table {
   font-size: 0.75rem;
        }

        .users-table th,
        .users-table td {
            padding: 0.75rem;
     }

        .action-buttons {
            flex-direction: column;
        }
  }
</style>
}

<div class="user-management-page">
    <div class="container">
        <!-- Page Header -->
     <div class="page-header">
        <h1 class="page-title">
   <i class="fas fa-users me-3"></i>
إدارة المستخدمين
    </h1>
     <p class="page-subtitle">
                إدارة حسابات المستخدمين ومراقبة نشاطهم على المنصة
    </p>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
    <div class="stat-card">
          <div class="stat-icon primary">
         <i class="fas fa-users"></i>
    </div>
    <div class="stat-content">
   <h3>@ViewBag.TotalUsers</h3>
        <p>إجمالي المستخدمين</p>
      </div>
  </div>

            <div class="stat-card">
      <div class="stat-icon success">
         <i class="fas fa-circle"></i>
    </div>
       <div class="stat-content">
           <h3>@ViewBag.OnlineUsers</h3>
          <p>متصل الآن</p>
              </div>
      </div>

    <div class="stat-card">
                <div class="stat-icon warning">
         <i class="fas fa-user-check"></i>
        </div>
       <div class="stat-content">
        <h3>@ViewBag.ActiveUsers</h3>
                    <p>مستخدم نشط</p>
           </div>
         </div>

            <div class="stat-card">
       <div class="stat-icon danger">
        <i class="fas fa-user-slash"></i>
  </div>
             <div class="stat-content">
            <h3>@ViewBag.BannedUsers</h3>
         <p>محظور</p>
      </div>
         </div>
        </div>

        <!-- Filters Section -->
    <div class="filters-section">
       <form method="get" asp-action="Users">
      <div class="filters-grid">
           <div class="filter-group">
       <label class="filter-label">البحث</label>
   <input type="text" 
  name="search" 
        class="filter-input" 
   placeholder="البريد الإلكتروني أو الاسم..."
           value="@ViewBag.SearchTerm">
           </div>

      <div class="filter-group">
       <label class="filter-label">الدور</label>
       <select name="role" class="filter-select">
      <option value="">كل الأدوار</option>
      <option value="Customer">عميل</option>
  <option value="Tailor">خياط</option>
  @* <option value="Corporate">شركة</option> *@ @* REMOVED: Corporate feature *@
      <option value="Admin">مدير</option>
        </select>
        </div>

       <div class="filter-group">
          <label class="filter-label">الحالة</label>
       <select name="status" class="filter-select">
            <option value="">الكل</option>
         <option value="Active" selected="@(ViewBag.StatusFilter == "Active")">نشط</option>
           <option value="Inactive" selected="@(ViewBag.StatusFilter == "Inactive")">غير نشط</option>
   <option value="Banned" selected="@(ViewBag.StatusFilter == "Banned")">محظور</option>
       </select>
   </div>

        <div class="filter-group">
         <label class="filter-label">&nbsp;</label>
        <div style="display: flex; gap: 0.5rem;">
   <button type="submit" class="btn-filter">
            <i class="fas fa-search me-2"></i>
          بحث
   </button>
     <a href="@Url.Action("Users", "AdminDashboard")" class="btn-reset">
     <i class="fas fa-redo me-2"></i>
         إعادة تعيين
    </a>
         </div>
  </div>
    </div>
    </form>
 </div>

  <!-- Users Table -->
  <div class="users-table-container">
       <div class="table-header">
  <h2 class="table-title">قائمة المستخدمين</h2>
       <span style="color: var(--gray-600); font-size: 0.875rem;">
           @Model.Count() مستخدم
    </span>
            </div>

            @if (Model.Any())
    {
      <table class="users-table">
          <thead>
    <tr>
     <th>المستخدم</th>
        <th>الدور</th>
      <th>الحالة</th>
         <th>البريد مؤكد</th>
           <th>تاريخ التسجيل</th>
 <th>آخر دخول</th>
      <th>الإجراءات</th>
</tr>
 </thead>
  <tbody>
            @foreach (var user in Model)
             {
          var isOnline = user.LastLoginAt.HasValue && 
    (DateTime.UtcNow - user.LastLoginAt.Value).TotalMinutes < 30;
     var isBanned = !user.IsActive;

   <tr>
           <td>
     <div class="user-info">
       <div class="user-avatar">
                @if (user.CustomerProfile?.ProfilePictureData != null || 
     user.TailorProfile?.ProfilePictureData != null)
          {
   <img src="@Url.Action("ProfilePicture", "Account", new { id = user.Id })" 
      alt="@user.Email" />
         }
  else
     {
     @(user.Email?.Substring(0, 1).ToUpper())
    }
    </div>
         <div class="user-details">
       <h4>
        @(user.CustomerProfile?.FullName ?? 
      user.TailorProfile?.FullName ?? 
       "مستخدم")
     </h4>
       <p>@user.Email</p>
  </div>
            </div>
                </td>
           <td>
         @{
       var roleClass = user.Role?.Name?.ToLower() ?? "customer";
        var roleText = user.Role?.Name switch
            {
    "Customer" => "عميل",
            "Tailor" => "خياط",
          "Admin" => "مدير",
             _ => "غير محدد"
          };
     }
   <span class="role-badge @roleClass">@roleText</span>
         </td>
            <td>
        @if (isBanned)
   {
    <span class="status-badge banned">
             <span class="status-dot"></span>
 محظور
                </span>
         }
   else if (isOnline)
     {
     <span class="status-badge online">
         <span class="status-dot"></span>
        متصل
        </span>
      }
     else
              {
         <span class="status-badge offline">
        <span class="status-dot"></span>
            غير متصل
       </span>
          }
   </td>
             <td>
           @if (user.EmailVerified)
       {
     <i class="fas fa-check-circle text-success"></i>
      <span style="color: var(--success-green); font-size: 0.75rem;">مؤكد</span>
       }
        else
            {
             <i class="fas fa-times-circle text-danger"></i>
         <span style="color: var(--danger-red); font-size: 0.75rem;">غير مؤكد</span>
   }
            </td>
         <td>
          <span style="font-size: 0.75rem; color: var(--gray-600);">
       @user.CreatedAt.ToString("yyyy/MM/dd")
    </span>
             </td>
        <td>
    @if (user.LastLoginAt.HasValue)
           {
          <span style="font-size: 0.75rem; color: var(--gray-600);">
             @user.LastLoginAt.Value.ToString("yyyy/MM/dd HH:mm")
     </span>
          }
   else
      {
          <span style="font-size: 0.75rem; color: var(--gray-600);">
     لم يسجل دخول
   </span>
              }
  </td>
     <td>
        <div class="action-buttons">
        <button class="btn-action btn-view" 
             onclick="viewUserDetails('@user.Id')">
    <i class="fas fa-eye"></i>
     عرض
   </button>

         @if (user.Role?.Name != "Admin")
        {
  if (isBanned)
           {
          <form method="post" 
 asp-action="UnbanUser" 
         asp-route-userId="@user.Id"
     style="display: inline;">
  @Html.AntiForgeryToken()
           <button type="submit" class="btn-action btn-unban">
         <i class="fas fa-user-check"></i>
    إلغاء الحظر
         </button>
</form>
         }
              else
      {
         <button class="btn-action btn-ban" 
                      onclick="confirmBan('@user.Id', '@(user.Email)')">
                 <i class="fas fa-ban"></i>
      حظر
</button>
 }
           }
        </div>
      </td>
         </tr>
    }
          </tbody>
    </table>

    <!-- Pagination (if needed) -->
    @if (ViewBag.TotalPages > 1)
      {
             <div class="pagination">
              <button class="pagination-btn" 
 disabled="@(ViewBag.CurrentPage == 1)"
         onclick="location.href='?page=@(ViewBag.CurrentPage - 1)&search=@ViewBag.SearchTerm&role=@ViewBag.RoleFilter&status=@ViewBag.StatusFilter'">
<i class="fas fa-chevron-right"></i>
     </button>

@for (int i = 1; i <= ViewBag.TotalPages; i++)
         {
       <button class="pagination-btn @(i == ViewBag.CurrentPage ? "active" : "")"
           onclick="location.href='?page=@i&search=@ViewBag.SearchTerm&role=@ViewBag.RoleFilter&status=@ViewBag.StatusFilter'">
      @i
     </button>
         }

  <button class="pagination-btn" 
         disabled="@(ViewBag.CurrentPage == ViewBag.TotalPages)"
onclick="location.href='?page=@(ViewBag.CurrentPage + 1)&search=@ViewBag.SearchTerm&role=@ViewBag.RoleFilter&status=@ViewBag.StatusFilter'">
      <i class="fas fa-chevron-left"></i>
     </button>
       </div>
        }
            }
   else
     {
 <div class="empty-state">
       <i class="fas fa-users-slash"></i>
         <h3>لا توجد نتائج</h3>
 <p>لم يتم العثور على مستخدمين بهذه المعايير</p>
        </div>
        }
        </div>
    </div>
</div>

<!-- Ban Confirmation Modal -->
<div class="modal fade" id="banModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">تأكيد حظر المستخدم</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
          <div class="modal-body">
      <p>هل أنت متأكد من حظر المستخدم <strong id="userEmail"></strong>؟</p>
        <p class="text-muted">سيتم منع المستخدم من تسجيل الدخول إلى المنصة.</p>
   </div>
            <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
       <form method="post" id="banForm" style="display: inline;">
      @Html.AntiForgeryToken()
 <button type="submit" class="btn btn-danger">تأكيد الحظر</button>
      </form>
 </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function confirmBan(userId, email) {
        document.getElementById('userEmail').textContent = email;
        document.getElementById('banForm').action = '/AdminDashboard/BanUser/' + userId;
        new bootstrap.Modal(document.getElementById('banModal')).show();
    }

    function viewUserDetails(userId) {
        // Redirect to user details page (to be implemented)
  window.location.href = '/AdminDashboard/UserDetails/' + userId;
    }

    // Auto-refresh online count every 60 seconds
    setInterval(function() {
        fetch('/AdminDashboard/GetOnlineCount')
       .then(response => response.json())
    .then(data => {
document.querySelector('.stat-card .success h3').textContent = data.count;
            });
    }, 60000);
</script>
}
