@model TafsilkPlatform.Web.Models.User

@{
    ViewData["Title"] = "تفاصيل المستخدم";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container my-4">
    <div class="row">
        <div class="col-md-4">
            <!-- User Profile Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-body text-center">
                  <div class="user-avatar mb-3">
           @if (Model.CustomerProfile?.ProfilePictureData != null || Model.TailorProfile?.ProfilePictureData != null)
                {
              <img src="@Url.Action("ProfilePicture", "Account", new { id = Model.Id })" 
           alt="@Model.Email" 
   class="rounded-circle"
         style="width: 120px; height: 120px; object-fit: cover;">
        }
             else
  {
                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
            style="width: 120px; height: 120px; font-size: 3rem; margin: 0 auto;">
                @(Model.Email?.Substring(0, 1).ToUpper())
             </div>
        }
    </div>

   <h3 class="mb-1">
        @(Model.CustomerProfile?.FullName ?? 
  Model.TailorProfile?.FullName ?? 
     Model.CorporateAccount?.CompanyName ?? 
          "مستخدم")
        </h3>
  <p class="text-muted mb-3">@Model.Email</p>

        @{
  var roleClass = Model.Role?.Name?.ToLower() ?? "customer";
              var roleText = Model.Role?.Name switch
           {
"Customer" => "عميل",
     "Tailor" => "خياط",
              "Corporate" => "شركة",
   "Admin" => "مدير",
 _ => "غير محدد"
 };
         }
 <span class="badge bg-primary mb-3">@roleText</span>

  @if (!Model.IsActive)
    {
       <div class="alert alert-danger" role="alert">
        <i class="fas fa-ban me-2"></i>
         محظور
     </div>
          }
   else if (Model.LastLoginAt.HasValue && (DateTime.UtcNow - Model.LastLoginAt.Value).TotalMinutes < 30)
      {
       <div class="alert alert-success" role="alert">
        <i class="fas fa-circle me-2"></i>
        متصل الآن
          </div>
     }
         else
                    {
       <div class="alert alert-secondary" role="alert">
             <i class="fas fa-circle me-2"></i>
       غير متصل
  </div>
          }

                    <div class="d-grid gap-2">
     @if (Model.Role?.Name != "Admin")
         {
        @if (!Model.IsActive)
          {
  <form method="post" asp-action="UnbanUser" asp-route-userId="@Model.Id">
           @Html.AntiForgeryToken()
    <button type="submit" class="btn btn-success">
                <i class="fas fa-user-check me-2"></i>
      إلغاء الحظر
     </button>
          </form>
        }
else
        {
    <button class="btn btn-danger" onclick="confirmBan('@Model.Id', '@Model.Email')">
         <i class="fas fa-ban me-2"></i>
     حظر المستخدم
        </button>
  }
            }
<a href="@Url.Action("Users", "AdminDashboard")" class="btn btn-outline-secondary">
                 <i class="fas fa-arrow-right me-2"></i>
           العودة للقائمة
              </a>
           </div>
        </div>
            </div>

      <!-- Quick Stats -->
  <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
     <h5 class="mb-0">إحصائيات سريعة</h5>
        </div>
      <div class="list-group list-group-flush">
            <div class="list-group-item d-flex justify-content-between">
                    <span>تاريخ التسجيل</span>
            <strong>@Model.CreatedAt.ToString("yyyy/MM/dd")</strong>
        </div>
      <div class="list-group-item d-flex justify-content-between">
<span>آخر دخول</span>
    <strong>
       @if (Model.LastLoginAt.HasValue)
        {
               @Model.LastLoginAt.Value.ToString("yyyy/MM/dd HH:mm")
    }
            else
            {
    <span class="text-muted">لم يسجل دخول</span>
      }
     </strong>
        </div>
                <div class="list-group-item d-flex justify-content-between">
         <span>البريد مؤكد</span>
        @if (Model.EmailVerified)
 {
 <span class="badge bg-success">نعم</span>
           }
                 else
           {
     <span class="badge bg-danger">لا</span>
   }
        </div>
   @if (ViewBag.Orders != null)
           {
             <div class="list-group-item d-flex justify-content-between">
   <span>عدد الطلبات</span>
     <strong>@ViewBag.Orders.Count</strong>
   </div>
       }
            </div>
          </div>
        </div>

        <div class="col-md-8">
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-3" role="tablist">
          <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#info" type="button">
<i class="fas fa-info-circle me-2"></i>
 المعلومات الأساسية
         </button>
                </li>
          @if (ViewBag.Orders != null && ViewBag.Orders.Count > 0)
{
        <li class="nav-item" role="presentation">
                 <button class="nav-link" data-bs-toggle="tab" data-bs-target="#orders" type="button">
     <i class="fas fa-shopping-cart me-2"></i>
      الطلبات
   </button>
         </li>
       }
        <li class="nav-item" role="presentation">
  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#activity" type="button">
    <i class="fas fa-history me-2"></i>
         السجل
      </button>
          </li>
      </ul>

            <!-- Tab Content -->
     <div class="tab-content">
         <!-- Basic Info Tab -->
       <div class="tab-pane fade show active" id="info" role="tabpanel">
            <div class="card shadow-sm">
<div class="card-header">
           <h5 class="mb-0">المعلومات الشخصية</h5>
             </div>
            <div class="card-body">
        <table class="table table-borderless">
    <tr>
            <th style="width: 40%;">البريد الإلكتروني:</th>
        <td>@Model.Email</td>
       </tr>
            <tr>
    <th>رقم الهاتف:</th>
             <td>@(Model.PhoneNumber ?? "غير محدد")</td>
      </tr>
 @if (Model.CustomerProfile != null)
    {
 <tr>
         <th>الاسم الكامل:</th>
       <td>@(Model.CustomerProfile.FullName ?? "غير محدد")</td>
            </tr>
            <tr>
  <th>تاريخ الميلاد:</th>
         <td>@(Model.CustomerProfile.DateOfBirth?.ToString("yyyy/MM/dd") ?? "غير محدد")</td>
 </tr>
      <tr>
    <th>الجنس:</th>
           <td>@(Model.CustomerProfile.Gender ?? "غير محدد")</td>
  </tr>
      }
               @if (Model.TailorProfile != null)
         {
      <tr>
     <th>اسم الورشة:</th>
<td>@(Model.TailorProfile.ShopName ?? "غير محدد")</td>
</tr>
           <tr>
    <th>العنوان:</th>
       <td>@(Model.TailorProfile.Address ?? "غير محدد")</td>
          </tr>
      <tr>
            <th>المدينة:</th>
       <td>@(Model.TailorProfile.City ?? "غير محدد")</td>
    </tr>
 <tr>
           <th>سنوات الخبرة:</th>
       <td>@(Model.TailorProfile.ExperienceYears?.ToString() ?? "غير محدد")</td>
     </tr>
       <tr>
    <th>حالة التحقق:</th>
          <td>
         @if (Model.TailorProfile.IsVerified)
        {
   <span class="badge bg-success">
    <i class="fas fa-check-circle me-1"></i>
         موثق
             </span>
    }
        else
         {
     <span class="badge bg-warning">
<i class="fas fa-clock me-1"></i>
              قيد المراجعة
     </span>
        }
               </td>
   </tr>
        <tr>
      <th>عدد الخدمات:</th>
     <td>@Model.TailorProfile.TailorServices.Count(s => !s.IsDeleted)</td>
            </tr>
 <tr>
         <th>صور المعرض:</th>
        <td>@Model.TailorProfile.PortfolioImages.Count(p => !p.IsDeleted)</td>
             </tr>
   }
             @if (Model.CorporateAccount != null)
             {
      <tr>
   <th>اسم الشركة:</th>
    <td>@(Model.CorporateAccount.CompanyName ?? "غير محدد")</td>
             </tr>
    <tr>
     <th>الشخص المسؤول:</th>
      <td>@(Model.CorporateAccount.ContactPerson ?? "غير محدد")</td>
    </tr>
     <tr>
  <th>المجال الصناعي:</th>
           <td>@(Model.CorporateAccount.Industry ?? "غير محدد")</td>
        </tr>
      <tr>
   <th>الرقم الضريبي:</th>
  <td>@(Model.CorporateAccount.TaxNumber ?? "غير محدد")</td>
       </tr>
     <tr>
                <th>حالة الموافقة:</th>
  <td>
 @if (Model.CorporateAccount.IsApproved)
           {
        <span class="badge bg-success">موافق عليه</span>
         }
             else
                    {
    <span class="badge bg-warning">قيد المراجعة</span>
     }
                  </td>
                </tr>
       }
         </table>

               @if (Model.UserAddresses.Any())
           {
       <hr>
     <h6 class="mb-3">العناوين المحفوظة</h6>
         @foreach (var address in Model.UserAddresses)
     {
       <div class="alert alert-light border">
  <strong>@address.Label</strong>
             @if (address.IsDefault)
         {
   <span class="badge bg-success me-2">افتراضي</span>
    }
 <p class="mb-0 text-muted">@address.Street, @address.City</p>
   </div>
     }
            }
           </div>
     </div>
                </div>

       <!-- Orders Tab -->
                @if (ViewBag.Orders != null && ViewBag.Orders.Count > 0)
           {
 <div class="tab-pane fade" id="orders" role="tabpanel">
      <div class="card shadow-sm">
         <div class="card-header">
    <h5 class="mb-0">آخر الطلبات</h5>
   </div>
              <div class="card-body p-0">
       <div class="table-responsive">
      <table class="table table-hover mb-0">
<thead class="table-light">
       <tr>
            <th>رقم الطلب</th>
        <th>التاريخ</th>
    <th>الحالة</th>
       <th>المبلغ</th>
        <th>الإجراء</th>
        </tr>
     </thead>
       <tbody>
     @foreach (var order in ViewBag.Orders)
       {
               <tr>
         <td>@order.OrderId.ToString().Substring(0, 8)</td>
             <td>@order.CreatedAt.ToString("yyyy/MM/dd")</td>
      <td>
         <span class="badge bg-info">@order.Status</span>
         </td>
         <td>@order.TotalPrice ريال</td>
        <td>
               <a href="@Url.Action("OrderDetails", "AdminDashboard", new { id = order.OrderId })" 
              class="btn btn-sm btn-outline-primary">
عرض
 </a>
          </td>
              </tr>
}
        </tbody>
      </table>
 </div>
  </div>
              </div>
                    </div>
     }

    <!-- Activity Log Tab -->
   <div class="tab-pane fade" id="activity" role="tabpanel">
        <div class="card shadow-sm">
       <div class="card-header">
  <h5 class="mb-0">سجل النشاط</h5>
</div>
 <div class="card-body">
     @if (ViewBag.ActivityLogs != null && ViewBag.ActivityLogs.Count > 0)
    {
     <div class="timeline">
          @foreach (var log in ViewBag.ActivityLogs)
             {
       <div class="timeline-item mb-3">
       <div class="d-flex">
<div class="timeline-marker bg-primary"></div>
    <div class="timeline-content ms-3">
        <h6 class="mb-1">@log.Action</h6>
         <p class="text-muted mb-1">@log.Details</p>
       <small class="text-muted">
         <i class="fas fa-clock me-1"></i>
    @log.CreatedAt.ToString("yyyy/MM/dd HH:mm")
   </small>
       @if (!string.IsNullOrEmpty(log.IpAddress))
  {
       <small class="text-muted ms-3">
   <i class="fas fa-network-wired me-1"></i>
   @log.IpAddress
    </small>
           }
        </div>
          </div>
              </div>
       }
   </div>
         }
      else
      {
            <p class="text-muted text-center py-4">لا يوجد سجل نشاط</p>
 }
     </div>
           </div>
     </div>
            </div>
        </div>
    </div>
</div>

<!-- Ban Confirmation Modal -->
<div class="modal fade" id="banModal" tabindex="-1">
    <div class="modal-dialog">
    <div class="modal-content">
         <div class="modal-header">
       <h5 class="modal-title">تأكيد حظر المستخدم</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <p>هل أنت متأكد من حظر المستخدم <strong id="userEmail"></strong>؟</p>
 <p class="text-muted">سيتم منع المستخدم من تسجيل الدخول إلى المنصة.</p>
       </div>
      <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
     <form method="post" id="banForm" style="display: inline;">
        @Html.AntiForgeryToken()
             <button type="submit" class="btn btn-danger">تأكيد الحظر</button>
    </form>
            </div>
        </div>
  </div>
</div>

@section Styles {
<style>
    .timeline {
        position: relative;
        padding-right: 20px;
    }

    .timeline-item {
        position: relative;
    }

    .timeline-marker {
        width: 12px;
      height: 12px;
        border-radius: 50%;
        position: absolute;
        right: -26px;
        top: 5px;
    }

    .timeline-item:not(:last-child)::before {
        content: '';
  position: absolute;
        right: -21px;
        top: 17px;
     width: 2px;
      height: calc(100% + 12px);
        background: #e5e7eb;
    }
</style>
}

@section Scripts {
<script>
    function confirmBan(userId, email) {
        document.getElementById('userEmail').textContent = email;
  document.getElementById('banForm').action = '/Admin/Users/Ban/' + userId;
        new bootstrap.Modal(document.getElementById('banModal')).show();
    }
</script>
}
