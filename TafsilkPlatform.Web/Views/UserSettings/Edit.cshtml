@model TafsilkPlatform.Web.ViewModels.UserSettingsViewModel

@{
    ViewData["Title"] = "إعدادات الحساب";
}

@section Styles {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
    <style>
        /* Settings Page Styles */
        .settings-page {
       background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
          min-height: calc(100vh - 200px);
      padding: 2rem 0;
      }

        .settings-header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%);
            color: white;
       padding: 2.5rem;
        border-radius: 16px;
        margin-bottom: 2rem;
          box-shadow: 0 8px 24px rgba(44, 90, 160, 0.2);
    position: relative;
            overflow: hidden;
      }

        .settings-header::before {
     content: '';
     position: absolute;
       top: -50%;
       right: -10%;
 width: 300px;
      height: 300px;
    background: rgba(255, 255, 255, 0.1);
  border-radius: 50%;
        }

        .settings-header h1 {
      margin: 0;
     font-size: 2.25rem;
     font-weight: 800;
         position: relative;
       z-index: 1;
 }

.settings-header p {
       margin: 0.75rem 0 0;
     opacity: 0.95;
    font-size: 1.05rem;
     position: relative;
            z-index: 1;
}

        .settings-card {
        background: white;
  border-radius: 16px;
padding: 2rem;
  margin-bottom: 1.5rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.06);
  border: 1px solid rgba(0,0,0,0.04);
    transition: all 0.3s;
   position: relative;
 overflow: hidden;
     }

        .settings-card::before {
   content: '';
      position: absolute;
    top: -100px;
    right: -100px;
   width: 200px;
       height: 200px;
 background: radial-gradient(circle, rgba(102, 126, 234, 0.03) 0%, transparent 70%);
          border-radius: 50%;
     pointer-events: none;
  }

        .settings-card:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
       transform: translateY(-2px);
     }

        .settings-card.quick-nav {
 background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
    }

        .settings-card.quick-nav::before {
       display: none;
    }

    .settings-card-header {
  display: flex;
      align-items: center;
     gap: 0.75rem;
       margin-bottom: 1.5rem;
   padding-bottom: 1rem;
     border-bottom: 2px solid #f1f3f5;
        }

      .settings-card-header i {
      color: #2c5aa0;
      font-size: 1.5rem;
     }

        .settings-card-header h2 {
  margin: 0;
    font-size: 1.5rem;
        font-weight: 700;
          color: #212529;
        }

      /* Role Display Card */
        .role-display-card {
   background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
    padding: 1.5rem;
     border-radius: 12px;
    margin-bottom: 1.5rem;
       box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  position: relative;
 overflow: hidden;
        }

        .role-display-card::before {
content: '';
     position: absolute;
    top: -50%;
left: -25%;
     width: 200px;
  height: 200px;
            background: rgba(255, 255, 255, 0.1);
         border-radius: 50%;
        }

        .role-display-content {
          position: relative;
      z-index: 1;
         display: flex;
    align-items: center;
            justify-content: space-between;
  flex-wrap: wrap;
 gap: 1rem;
        }

        .role-info {
   display: flex;
            align-items: center;
   gap: 1rem;
        }

        .role-icon {
            width: 60px;
      height: 60px;
     background: rgba(255, 255, 255, 0.2);
 border-radius: 12px;
         display: flex;
   align-items: center;
  justify-content: center;
   font-size: 1.75rem;
      }

        .role-details h3 {
 margin: 0;
     font-size: 1.25rem;
  font-weight: 700;
     }

      .role-badge {
      display: inline-block;
       padding: 0.4rem 1rem;
   border-radius: 50px;
  font-size: 0.85rem;
   font-weight: 600;
   background: rgba(255, 255, 255, 0.25);
 margin-top: 0.25rem;
   }

  .role-badge-customer { background: rgba(255, 255, 255, 0.25); }
  .role-badge-tailor { background: rgba(255, 193, 7, 0.3); }
        .role-badge-corporate { background: rgba(156, 39, 176, 0.3); }

    .btn-become-tailor {
   background: rgba(255, 255, 255, 0.95);
            color: #667eea;
     padding: 0.75rem 1.5rem;
   border-radius: 50px;
      border: none;
        font-weight: 700;
      cursor: pointer;
   transition: all 0.3s;
text-decoration: none;
 display: inline-flex;
     align-items: center;
      gap: 0.5rem;
     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

    .btn-become-tailor:hover {
    transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
     color: #5568d3;
      }

        .profile-picture-section {
     text-align: center;
   padding: 2.5rem;
  background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
     border-radius: 16px;
    margin-bottom: 2rem;
        }

     .profile-picture-wrapper {
    position: relative;
            width: 180px;
     height: 180px;
      margin: 0 auto 1.5rem;
    }

      .profile-picture-preview,
        .profile-picture-placeholder {
width: 180px;
 height: 180px;
     border-radius: 50%;
     object-fit: cover;
       border: 6px solid #fff;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

  .profile-picture-placeholder {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    display: flex;
 align-items: center;
     justify-content: center;
        }

        .profile-picture-placeholder i {
          font-size: 5rem;
  color: #6c757d;
  }

        .profile-picture-delete {
            position: absolute;
   top: 0;
   right: 0;
            width: 40px;
            height: 40px;
       border-radius: 50%;
         background: #dc3545;
     color: white;
    border: 4px solid white;
    display: flex;
    align-items: center;
          justify-content: center;
   cursor: pointer;
    transition: all 0.3s;
   box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
    }

        .profile-picture-delete:hover {
          background: #c82333;
     transform: scale(1.15);
        }

 .btn-upload-photo {
       background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%);
         color: white;
      padding: 0.85rem 2.25rem;
    border-radius: 50px;
   cursor: pointer;
            display: inline-flex;
  align-items: center;
         gap: 0.5rem;
     transition: all 0.3s;
 font-weight: 700;
     border: none;
      box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3);
   }

     .btn-upload-photo:hover {
    transform: translateY(-3px);
     box-shadow: 0 6px 20px rgba(44, 90, 160, 0.4);
}

    .sidebar-card {
            position: sticky;
      top: 2rem;
        }

      .profile-summary-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 16px;
  padding: 2rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.06);
  border: 1px solid rgba(0,0,0,0.04);
     text-align: center;
    margin-bottom: 1.5rem;
       transition: all 0.3s;
    position: relative;
        overflow: hidden;
  }

      .profile-summary-card::before {
       content: '';
    position: absolute;
            top: -50%;
         right: -20%;
width: 150px;
    height: 150px;
   background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
     border-radius: 50%;
            z-index: 0;
        }

        .profile-summary-card:hover {
   box-shadow: 0 6px 20px rgba(0,0,0,0.08);
     transform: translateY(-2px);
        }

        .profile-avatar {
     position: relative;
  margin-bottom: 1.25rem;
      z-index: 1;
        }

  .profile-avatar img,
  .profile-avatar > div {
    width: 120px;
  height: 120px;
            object-fit: cover;
        border: 5px solid #fff;
box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        transition: all 0.3s;
        }

 .profile-summary-card:hover .profile-avatar img,
   .profile-summary-card:hover .profile-avatar > div {
   transform: scale(1.05);
   box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
   }

.profile-name {
     font-size: 1.35rem;
      font-weight: 800;
  color: #212529;
  margin-bottom: 0.5rem;
position: relative;
    z-index: 1;
    background: linear-gradient(135deg, #2c5aa0 0%, #667eea 100%);
   -webkit-background-clip: text;
       -webkit-text-fill-color: transparent;
   background-clip: text;
        }

    .profile-email {
   font-size: 0.9rem;
      color: #6c757d;
        margin-bottom: 1.25rem;
          position: relative;
       z-index: 1;
   font-weight: 500;
        }

        .profile-role-badge {
 display: inline-block;
padding: 0.5rem 1.25rem;
 border-radius: 50px;
     font-size: 0.85rem;
     font-weight: 700;
      position: relative;
       z-index: 1;
   box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
     transition: all 0.3s;
        }

        .profile-role-badge-customer {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
color: #1976d2;
        }

        .profile-role-badge-tailor {
 background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
 color: #f57c00;
        }

    .profile-role-badge-corporate {
       background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            color: #7b1fa2;
   }

  .profile-role-badge:hover {
 transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

      /* Enhanced Quick Nav and Tips Card Styles */
        .quick-nav .list-group-item {
            border: none;
    border-left: 3px solid transparent;
        transition: all 0.3s;
 padding: 0.75rem 1rem;
  border-radius: 8px;
        margin-bottom: 0.25rem;
       font-weight: 500;
  position: relative;
      overflow: hidden;
        }

      .quick-nav .list-group-item::before {
    content: '';
  position: absolute;
 left: 0;
        top: 0;
     height: 100%;
     width: 0;
     background: linear-gradient(90deg, rgba(44, 90, 160, 0.1) 0%, rgba(102, 126, 234, 0.05) 100%);
       transition: width 0.3s;
    z-index: 0;
   }

        .quick-nav .list-group-item:hover::before {
   width: 100%;
        }

  .quick-nav .list-group-item:hover {
  background: transparent;
            border-left-color: #2c5aa0;
 padding-left: 1.25rem;
   color: #2c5aa0;
    }

    .quick-nav .list-group-item i {
position: relative;
z-index: 1;
 transition: transform 0.3s;
  }

  .quick-nav .list-group-item:hover i {
 transform: scale(1.15);
     }

        .quick-nav .list-group-item span {
 position: relative;
       z-index: 1;
        }

        .tips-card {
        background: linear-gradient(135deg, #fff9e6 0%, #fffaed 100%);
 border: 2px solid #ffc107;
 border-radius: 16px;
    padding: 1.5rem;
       position: relative;
      overflow: hidden;
  box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15);
    }

    .tips-card::before {
    content: '';
 position: absolute;
top: -50%;
    left: -20%;
  width: 150px;
       height: 150px;
     background: radial-gradient(circle, rgba(255, 193, 7, 0.2) 0%, transparent 70%);
    border-radius: 50%;
        }

 .tips-card h6 {
 font-weight: 800;
       color: #856404;
   position: relative;
       z-index: 1;
    font-size: 1rem;
        }

        .tips-card ul {
    list-style: none;
       padding: 0;
     margin: 0;
       position: relative;
   z-index: 1;
        }

        .tips-card li {
  padding: 0.5rem 0;
        display: flex;
   align-items: start;
     gap: 0.5rem;
      color: #856404;
      font-size: 0.9rem;
    transition: all 0.2s;
     }

      .tips-card li:hover {
  padding-left: 0.5rem;
       color: #664d03;
        }

 .tips-card li::before {
     content: "✓";
    color: #28a745;
      font-weight: bold;
    font-size: 1.2rem;
     flex-shrink: 0;
      }

        /* Crop Modal Styles */
    .crop-modal {
  display: none;
            position: fixed;
    inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
    align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
    }

        .crop-modal.show {
            display: flex;
    }

    @@keyframes fadeIn {
         from { opacity: 0; }
        to { opacity: 1; }
        }

        .crop-modal-content {
      background: white;
   border-radius: 16px;
            width: 90%;
         max-width: 900px;
      max-height: 90vh;
       overflow: hidden;
       box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
animation: modalSlideIn 0.3s ease-out;
   display: flex;
 flex-direction: column;
        }

 @@keyframes modalSlideIn {
   from {
       opacity: 0;
            transform: scale(0.9) translateY(-20px);
          }
    to {
          opacity: 1;
      transform: scale(1) translateY(0);
      }
        }

        .crop-modal-header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%);
        color: white;
      padding: 1.5rem;
   display: flex;
        align-items: center;
            justify-content: space-between;
     flex-shrink: 0;
  }

 .crop-modal-title {
            font-size: 1.5rem;
     font-weight: 700;
margin: 0;
            display: flex;
  align-items: center;
            gap: 0.5rem;
        }

        .crop-modal-close {
            background: rgba(255, 255, 255, 0.2);
   border: none;
   color: white;
        font-size: 1.5rem;
 cursor: pointer;
            padding: 0.5rem;
    width: 40px;
         height: 40px;
            border-radius: 8px;
            transition: all 0.2s;
  display: flex;
         align-items: center;
       justify-content: center;
    }

        .crop-modal-close:hover {
background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
      }

  .crop-modal-body {
 padding: 1.5rem;
  flex: 1;
            overflow: auto;
      display: flex;
       flex-direction: column;
         gap: 1rem;
        }

        .crop-container {
            width: 100%;
            height: 500px;
    background: #212529;
            border-radius: 12px;
   overflow: hidden;
 position: relative;
        }

        .crop-container img {
   max-width: 100%;
        display: block;
        }

        .crop-instructions {
     padding: 1rem;
      background: linear-gradient(135deg, #e7f3ff 0%, #cfe9ff 100%);
         border-radius: 8px;
       font-size: 0.9rem;
            display: flex;
            align-items: start;
       gap: 0.75rem;
            border-left: 4px solid #2c5aa0;
        }

        .crop-instructions i {
    color: #2c5aa0;
            font-size: 1.25rem;
         margin-top: 0.125rem;
        }

        .crop-instructions-text {
     flex: 1;
        }

    .crop-instructions strong {
            display: block;
            margin-bottom: 0.5rem;
   color: #1e3a5f;
        }

        .crop-instructions ul {
     margin: 0;
            padding-left: 1.25rem;
        }

        .crop-instructions li {
  margin-bottom: 0.25rem;
        }

        .crop-modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #dee2e6;
            display: flex;
   gap: 0.75rem;
            justify-content: flex-end;
            background: #f8f9fa;
      flex-shrink: 0;
     }

        .btn-crop-cancel {
            background: transparent;
    border: 2px solid #6c757d;
    color: #6c757d;
            padding: 0.75rem 1.5rem;
     border-radius: 50px;
  font-weight: 600;
     cursor: pointer;
    transition: all 0.3s;
     font-size: 0.95rem;
        }

        .btn-crop-cancel:hover {
         background: #6c757d;
            color: white;
      transform: translateY(-2px);
        }

    .btn-crop-apply {
       background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%);
 color: white;
     padding: 0.75rem 2rem;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
  font-size: 0.95rem;
            display: inline-flex;
  align-items: center;
   gap: 0.5rem;
    box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3);
   }

        .btn-crop-apply:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 90, 160, 0.4);
        }

  .btn-crop-apply:disabled {
  opacity: 0.6;
            cursor: not-allowed;
  transform: none;
        }

        /* Toast Notifications */
      .toast-notification {
            position: fixed;
            top: 20px;
      right: 20px;
            background: white;
       border-radius: 12px;
            padding: 1rem 1.5rem;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
 z-index: 10000;
            animation: slideIn 0.3s ease-out;
      display: flex;
      align-items: center;
       gap: 0.75rem;
         min-width: 320px;
  }

      .toast-notification.success {
      border-left: 4px solid #28a745;
 }

        .toast-notification.error {
   border-left: 4px solid #dc3545;
        }

   @@keyframes slideIn {
     from {
      transform: translateX(100%);
  opacity: 0;
 }
    to {
    transform: translateX(0);
        opacity: 1;
      }
        }

  /* Form Controls */
 .form-control {
    border: 2px solid #e9ecef;
     border-radius: 8px;
        padding: 0.75rem 1rem;
      transition: all 0.3s;
 }

        .form-control:focus {
     border-color: #2c5aa0;
   box-shadow: 0 0 0 4px rgba(44, 90, 160, 0.1);
    }

     .form-label {
 font-weight: 600;
     color: #495057;
 margin-bottom: 0.5rem;
  }

    /* Responsive */
        @@media (max-width: 768px) {
 .settings-header h1 {
 font-size: 1.75rem;
            }

       .settings-card {
    padding: 1.5rem;
        }

  .profile-picture-wrapper,
 .profile-picture-preview,
   .profile-picture-placeholder {
     width: 140px;
   height: 140px;
            }

            .crop-container {
       height: 300px;
     }

    .crop-modal-content {
    width: 95%;
     max-height: 95vh;
  }

       .crop-modal-footer {
          flex-direction: column-reverse;
   }

 .crop-modal-footer button {
      width: 100%;
  }

.role-display-content {
 flex-direction: column;
 text-align: center;
        }

    .role-info {
 flex-direction: column;
         }
        }
 </style>
}

<div class="container settings-page">
    <!-- Page Header -->
  <div class="settings-header">
    <h1><i class="fas fa-user-cog me-2"></i>إعدادات الحساب</h1>
     <p>قم بإدارة معلوماتك الشخصية وتفضيلات الإشعارات والأمان</p>
    </div>

    <!-- Success/Error Messages -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
   <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
 </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
   <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
    }

    <div class="row">
        <!-- Sidebar -->
  <div class="col-lg-3">
  <div class="sidebar-card">
  <!-- Profile Summary Card -->
<div class="profile-summary-card">
<div class="profile-avatar">
  @if (!string.IsNullOrEmpty(Model.ProfilePictureUrl))
      {
  <img src="@Model.ProfilePictureUrl" alt="@Model.FullName" 
        class="rounded-circle">
       }
else
     {
      <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto">
     <i class="fas fa-user fa-3x text-secondary"></i>
 </div>
      }
    </div>
<h5 class="profile-name">@Model.FullName</h5>
     <p class="profile-email">@Model.Email</p>
     <span class="profile-role-badge profile-role-badge-@Model.Role.ToLower()">
     @if (Model.Role == "Customer")
    {
   <i class="fas fa-user me-1"></i>
   <span>عميل</span>
      }
   else if (Model.Role == "Tailor")
{
    <i class="fas fa-cut me-1"></i>
   <span>خياط</span>
    }
   else
   {
    <i class="fas fa-building me-1"></i>
<span>شركة</span>
     }
   </span>
    </div>

         <!-- Quick Navigation -->
        <div class="settings-card quick-nav">
            <h6 class="mb-3"><i class="fas fa-compass me-2"></i>التنقل السريع</h6>
 <div class="list-group list-group-flush">
    <a href="#role-info" class="list-group-item list-group-item-action">
      <i class="fas fa-user-tag me-2"></i>الدور الحالي
      </a>
 <a href="#profile-picture" class="list-group-item list-group-item-action">
      <i class="fas fa-camera me-2"></i>الصورة الشخصية
 </a>
            <a href="#personal-info" class="list-group-item list-group-item-action">
   <i class="fas fa-id-card me-2"></i>المعلومات الشخصية
    </a>
   @if (Model.Role == "Tailor")
       {
              <a href="#business-info" class="list-group-item list-group-item-action">
        <i class="fas fa-store me-2"></i>معلومات المحل
  </a>
    }
     @if (Model.Role == "Corporate")
   {
         <a href="#company-info" class="list-group-item list-group-item-action">
    <i class="fas fa-building me-2"></i>معلومات الشركة
    </a>
      }
    <a href="#password" class="list-group-item list-group-item-action">
        <i class="fas fa-shield-alt me-2"></i>كلمة المرور
          </a>
  <a href="#notifications" class="list-group-item list-group-item-action">
  <i class="fas fa-bell me-2"></i>الإشعارات
     </a>
         </div>
        </div>

       <!-- Tips Card -->
      <div class="tips-card">
         <h6 class="mb-3"><i class="fas fa-lightbulb me-2"></i>نصائح مفيدة</h6>
     <ul>
    <li>احتفظ بمعلوماتك محدثة دائماً</li>
        <li>استخدم صورة واضحة لملفك الشخصي</li>
       <li>قم بتغيير كلمة المرور بانتظام</li>
  <li>فعّل الإشعارات المهمة</li>
      </ul>
    </div>
            </div>
 </div>

    <!-- Main Content -->
        <div class="col-lg-9">
      <!-- Role Display Card -->
          <div class="role-display-card" id="role-info">
     <div class="role-display-content">
    <div class="role-info">
      <div class="role-icon">
           @if (Model.Role == "Customer")
  {
          <i class="fas fa-user"></i>
         }
  else if (Model.Role == "Tailor")
       {
        <i class="fas fa-cut"></i>
 }
    else
  {
<i class="fas fa-building"></i>
          }
 </div>
   <div class="role-details">
  <h3>الدور الحالي</h3>
        <span class="role-badge role-badge-@Model.Role.ToLower()">
      @(Model.Role == "Customer" ? "عميل" : Model.Role == "Tailor" ? "خياط" : "شركة")
  </span>
          </div>
     </div>
    @if (Model.Role == "Customer")
          {
             <a asp-controller="Account" asp-action="RequestRoleChange" class="btn-become-tailor">
      <i class="fas fa-star"></i>
          <span>أصبح خياطاً</span>
          </a>
}
       </div>
  </div>

 <form asp-action="Edit" method="post" enctype="multipart/form-data" id="settingsForm">
     @Html.AntiForgeryToken()
     <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
       <input type="hidden" asp-for="UserId" />
        <input type="hidden" asp-for="Role" />
        <input type="hidden" asp-for="ProfilePictureUrl" id="profilePictureUrl" />
     <input type="hidden" name="ProfilePicture" id="croppedImageInput" />

          <!-- Profile Picture Section -->
                <div class="settings-card" id="profile-picture">
          <div class="settings-card-header">
            <i class="fas fa-camera"></i>
      <h2>الصورة الشخصية</h2>
     </div>
  
    <div class="profile-picture-section">
    <div class="profile-picture-wrapper" id="profilePictureWrapper">
      @if (!string.IsNullOrEmpty(Model.ProfilePictureUrl))
{
  <img src="@Model.ProfilePictureUrl" alt="@Model.FullName" 
        class="profile-picture-preview" id="profilePicturePreview" />
        <button type="button" class="profile-picture-delete" id="deletePhotoBtn" 
 title="حذف الصورة">
<i class="fas fa-times"></i>
         </button>
      }
      else
 {
         <div class="profile-picture-placeholder" id="profilePicturePlaceholder">
        <i class="fas fa-user"></i>
     </div>
    <img src="#" alt="الصورة الشخصية" 
 class="profile-picture-preview" id="profilePicturePreview" 
          style="display: none;" />
        }
    </div>

        <div>
           <label for="profilePictureFile" class="btn-upload-photo">
  <i class="fas fa-camera"></i>
  <span>@(string.IsNullOrEmpty(Model.ProfilePictureUrl) ? "تحميل صورة" : "تغيير الصورة")</span>
   </label>
<input type="file" id="profilePictureFile" accept="image/jpeg,image/png,image/gif,image/webp" 
         style="display: none;" />
      <p class="text-muted small mt-3">JPG, PNG, GIF أو WEBP. بحد أقصى 5 ميجابايت</p>
         </div>
          </div>
          </div>

<!-- Personal Information -->
        <div class="settings-card" id="personal-info">
        <div class="settings-card-header">
   <i class="fas fa-id-card"></i>
    <h2>المعلومات الشخصية</h2>
 </div>

      <div class="row">
            <div class="col-md-6 mb-3">
  <label asp-for="FullName" class="form-label"></label>
    <input asp-for="FullName" class="form-control" placeholder="أدخل اسمك الكامل" />
         <span asp-validation-for="FullName" class="text-danger"></span>
       </div>
    <div class="col-md-6 mb-3">
        <label asp-for="Email" class="form-label"></label>
         <input asp-for="Email" class="form-control" readonly />
<small class="text-muted">لا يمكن تغيير البريد الإلكتروني</small>
      <span asp-validation-for="Email" class="text-danger"></span>
 </div>
 </div>

<div class="row">
           <div class="col-md-6 mb-3">
  <label asp-for="PhoneNumber" class="form-label"></label>
<input asp-for="PhoneNumber" class="form-control" type="tel" placeholder="أدخل رقم الهاتف" />
      <span asp-validation-for="PhoneNumber" class="text-danger"></span>
          </div>
<div class="col-md-6 mb-3">
      <label asp-for="City" class="form-label"></label>
  <input asp-for="City" class="form-control" placeholder="أدخل المدينة" />
        <span asp-validation-for="City" class="text-danger"></span>
       </div>
  </div>

           <div class="row">
       <div class="col-md-6 mb-3">
    <label asp-for="DateOfBirth" class="form-label"></label>
     <input asp-for="DateOfBirth" type="date" class="form-control" />
     <span asp-validation-for="DateOfBirth" class="text-danger"></span>
    </div>
 </div>

             <div class="mb-3">
      <label asp-for="Bio" class="form-label"></label>
   <textarea asp-for="Bio" class="form-control" rows="4" 
        placeholder="أكتب نبذة مختصرة عن نفسك..."></textarea>
  <span asp-validation-for="Bio" class="text-danger"></span>
  <small class="text-muted">@((Model.Bio?.Length ?? 0)) / 500 حرف</small>
        </div>
         </div>

           <!-- Business Info (Tailor) -->
         @if (Model.Role == "Tailor")
      {
   <div class="settings-card" id="business-info">
            <div class="settings-card-header">
 <i class="fas fa-store"></i>
<h2>معلومات المحل</h2>
  </div>

   <div class="row">
  <div class="col-md-6 mb-3">
   <label asp-for="ShopName" class="form-label"></label>
    <input asp-for="ShopName" class="form-control" placeholder="أدخل اسم المحل" />
    <span asp-validation-for="ShopName" class="text-danger"></span>
         </div>
  <div class="col-md-6 mb-3">
   <label asp-for="Address" class="form-label"></label>
       <input asp-for="Address" class="form-control" placeholder="أدخل العنوان" />
     <span asp-validation-for="Address" class="text-danger"></span>
             </div>
 </div>
 </div>
       }

       <!-- Company Info (Corporate) -->
          @if (Model.Role == "Corporate")
       {
      <div class="settings-card" id="company-info">
      <div class="settings-card-header">
     <i class="fas fa-building"></i>
      <h2>معلومات الشركة</h2>
         </div>

         <div class="row">
  <div class="col-md-6 mb-3">
<label asp-for="CompanyName" class="form-label"></label>
        <input asp-for="CompanyName" class="form-control" placeholder="أدخل اسم الشركة" />
           <span asp-validation-for="CompanyName" class="text-danger"></span>
  </div>
       <div class="col-md-6 mb-3">
         <label asp-for="ContactPerson" class="form-label"></label>
    <input asp-for="ContactPerson" class="form-control" placeholder="أدخل اسم الشخص المسؤول" />
            <span asp-validation-for="ContactPerson" class="text-danger"></span>
     </div>
   </div>
          </div>
 }

   <!-- Password Change -->
     <div class="settings-card" id="password">
       <div class="settings-card-header">
  <i class="fas fa-shield-alt"></i>
        <h2>تغيير كلمة المرور</h2>
 </div>

       <div class="alert alert-info">
     <i class="fas fa-info-circle me-2"></i>
    اترك الحقول فارغة إذا كنت لا ترغب في تغيير كلمة المرور
    </div>

<div class="row">
     <div class="col-md-4 mb-3">
         <label asp-for="CurrentPassword" class="form-label"></label>
           <input asp-for="CurrentPassword" type="password" class="form-control" 
   placeholder="كلمة المرور الحالية" />
        <span asp-validation-for="CurrentPassword" class="text-danger"></span>
       </div>
   <div class="col-md-4 mb-3">
      <label asp-for="NewPassword" class="form-label"></label>
 <input asp-for="NewPassword" type="password" class="form-control" 
 placeholder="كلمة المرور الجديدة" />
    <span asp-validation-for="NewPassword" class="text-danger"></span>
       </div>
     <div class="col-md-4 mb-3">
 <label asp-for="ConfirmNewPassword" class="form-label"></label>
 <input asp-for="ConfirmNewPassword" type="password" class="form-control" 
  placeholder="تأكيد كلمة المرور" />
           <span asp-validation-for="ConfirmNewPassword" class="text-danger"></span>
    </div>
        </div>
          </div>

     <!-- Notifications -->
   <div class="settings-card" id="notifications">
       <div class="settings-card-header">
      <i class="fas fa-bell"></i>
          <h2>إعدادات الإشعارات</h2>
           </div>

            <div class="form-check form-switch mb-3">
             <input asp-for="EmailNotifications" class="form-check-input" type="checkbox" />
   <label asp-for="EmailNotifications" class="form-check-label"></label>
        <small class="d-block text-muted ms-4">تلقي التحديثات والإشعارات المهمة عبر البريد الإلكتروني</small>
      </div>

   <div class="form-check form-switch mb-3">
       <input asp-for="SmsNotifications" class="form-check-input" type="checkbox" />
  <label asp-for="SmsNotifications" class="form-check-label"></label>
          <small class="d-block text-muted ms-4">تلقي الإشعارات الهامة عبر الرسائل النصية</small>
          </div>

          <div class="form-check form-switch">
         <input asp-for="PromotionalNotifications" class="form-check-input" type="checkbox" />
      <label asp-for="PromotionalNotifications" class="form-check-label"></label>
    <small class="d-block text-muted ms-4">تلقي العروض الخاصة والمحتوى الترويجي</small>
   </div>
  </div>

    <!-- Action Buttons -->
    <div class="d-flex gap-3 mb-4">
        <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
  <i class="fas fa-save me-2"></i>حفظ التعديلات
     </button>
    <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary btn-lg px-4">
    <i class="fas fa-times me-2"></i>إلغاء
         </a>
      </div>
 </form>
    </div>
    </div>
</div>

<!-- Crop Modal -->
<div id="cropModal" class="crop-modal" role="dialog" aria-modal="true" aria-labelledby="crop-modal-title">
    <div class="crop-modal-content">
      <div class="crop-modal-header">
<h3 class="crop-modal-title" id="crop-modal-title">
      <i class="fas fa-crop-alt"></i>
       <span>تعديل وتحسين الصورة</span>
    </h3>
       <button type="button" class="crop-modal-close" id="cropModalClose" aria-label="إغلاق">
                <i class="fas fa-times"></i>
    </button>
        </div>
        <div class="crop-modal-body">
            <div class="crop-container">
      <img id="cropImage" src="" alt="صورة للتعديل" />
  </div>
            <div class="crop-instructions">
<i class="fas fa-info-circle"></i>
           <div class="crop-instructions-text">
   <strong>كيفية استخدام أداة التعديل:</strong>
         <ul>
      <li>اسحب الصورة لتحريكها داخل الإطار</li>
        <li>استخدم عجلة الماوس للتكبير أو التصغير</li>
           <li>اسحب حواف الإطار لتغيير حجم المنطقة المحددة</li>
      <li>اضغط "تطبيق" عندما تصبح الصورة جاهزة</li>
     </ul>
    </div>
            </div>
        </div>
        <div class="crop-modal-footer">
 <button type="button" class="btn-crop-cancel" id="cancelCropBtn">
          <i class="fas fa-times me-2"></i>إلغاء
          </button>
            <button type="button" class="btn-crop-apply" id="applyCropBtn">
  <i class="fas fa-check me-2"></i>تطبيق الصورة
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script>
        // Profile Picture Manager with Cropping
        class ProfilePictureManager {
            constructor() {
       this.cropper = null;
        this.currentImageBlob = null;
    this.hasNewImage = false;
      this.initializeElements();
       this.attachEventListeners();
      }

 initializeElements() {
      this.fileInput = document.getElementById('profilePictureFile');
      this.preview = document.getElementById('profilePicturePreview');
           this.placeholder = document.getElementById('profilePicturePlaceholder');
    this.deleteBtn = document.getElementById('deletePhotoBtn');
    this.cropModal = document.getElementById('cropModal');
           this.cropImage = document.getElementById('cropImage');
  this.settingsForm = document.getElementById('settingsForm');
      this.submitBtn = document.getElementById('submitBtn');
      this.applyCropBtn = document.getElementById('applyCropBtn');
  this.cancelCropBtn = document.getElementById('cancelCropBtn');
  this.cropModalClose = document.getElementById('cropModalClose');
       }

  attachEventListeners() {
if (this.fileInput) {
         this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
    }
   if (this.deleteBtn) {
this.deleteBtn.addEventListener('click', () => this.handleDeletePhoto());
      }
       if (this.cropModalClose) {
  this.cropModalClose.addEventListener('click', () => this.closeCropModal());
  }
    if (this.cancelCropBtn) {
      this.cancelCropBtn.addEventListener('click', () => this.closeCropModal());
       }
          if (this.applyCropBtn) {
           this.applyCropBtn.addEventListener('click', () => this.applyCrop());
  }
        if (this.settingsForm) {
        this.settingsForm.addEventListener('submit', (e) => this.handleFormSubmit(e));
   }
           document.addEventListener('keydown', (e) => this.handleKeyboard(e));
         }

        handleFileSelect(e) {
             const file = e.target.files[0];
       if (!file) return;

    if (!file.type.match('image.*')) {
this.showToast('يرجى اختيار ملف صورة صالح', 'error');
      this.fileInput.value = '';
            return;
           }

     const maxSize = 5 * 1024 * 1024;
   if (file.size > maxSize) {
    this.showToast('حجم الصورة كبير جداً. الحد الأقصى 5 ميجابايت', 'error');
   this.fileInput.value = '';
     return;
     }

    this.openCropModal(file);
       }

    handleDeletePhoto() {
    if (!confirm('هل أنت متأكد من حذف الصورة الشخصية؟')) return;

 if (this.preview) {
      this.preview.style.display = 'none';
     }
          if (this.placeholder) {
    this.placeholder.style.display = 'flex';
     }
     if (this.deleteBtn) {
    this.deleteBtn.style.display = 'none';
        }

 this.hasNewImage = false;
    this.currentImageBlob = null;
     document.getElementById('profilePictureUrl').value = '';
     
        this.showToast('سيتم حذف الصورة عند حفظ التغييرات', 'success');
     }

    openCropModal(file) {
         const reader = new FileReader();
         reader.onload = (e) => {
  this.cropImage.src = e.target.result;
this.cropModal.classList.add('show');
  document.body.style.overflow = 'hidden';

    if (this.cropper) {
         this.cropper.destroy();
     }

       this.cropper = new Cropper(this.cropImage, {
   aspectRatio: 1,
  viewMode: 2,
        dragMode: 'move',
   autoCropArea: 0.8,
    restore: false,
   guides: true,
           center: true,
            cropBoxMovable: true,
 cropBoxResizable: true,
       zoomOnWheel: true
     });
  };
     reader.readAsDataURL(file);
     }

  closeCropModal() {
    this.cropModal.classList.remove('show');
     document.body.style.overflow = '';
           if (this.cropper) {
      this.cropper.destroy();
      this.cropper = null;
           }
         if (this.fileInput) {
    this.fileInput.value = '';
    }
     }

            applyCrop() {
if (!this.cropper) return;

         this.applyCropBtn.disabled = true;
this.applyCropBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري المعالجة...';

   const canvas = this.cropper.getCroppedCanvas({
   width: 400,
              height: 400,
    imageSmoothingEnabled: true,
 imageSmoothingQuality: 'high'
   });

     canvas.toBlob((blob) => {
      if (!blob) {
      this.showToast('فشل معالجة الصورة', 'error');
    this.resetApplyButton();
return;
     }

  this.currentImageBlob = blob;
 this.hasNewImage = true;

       const url = URL.createObjectURL(blob);
         this.preview.src = url;
      this.preview.style.display = 'block';
 
    if (this.placeholder) {
       this.placeholder.style.display = 'none';
  }
    if (this.deleteBtn) {
  this.deleteBtn.style.display = 'flex';
}

   this.closeCropModal();
         this.resetApplyButton();
       this.showToast('تم تجهيز الصورة. اضغط "حفظ التعديلات" لرفعها.', 'success');
    }, 'image/jpeg', 0.85);
    }

            resetApplyButton() {
   this.applyCropBtn.disabled = false;
this.applyCropBtn.innerHTML = '<i class="fas fa-check me-2"></i>تطبيق الصورة';
            }

 async handleFormSubmit(e) {
 if (this.hasNewImage && this.currentImageBlob) {
           e.preventDefault();

     this.submitBtn.disabled = true;
        this.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الحفظ...';

     const formData = new FormData(this.settingsForm);
          formData.delete('ProfilePicture');
      formData.append('ProfilePicture', this.currentImageBlob, 'profile-picture.jpg');

      try {
  const response = await fetch(this.settingsForm.action, {
   method: 'POST',
  body: formData
     });

              if (response.redirected) {
     window.location.href = response.url;
  } else if (response.ok) {
        this.showToast('تم حفظ التغييرات بنجاح', 'success');
          setTimeout(() => window.location.reload(), 1500);
             } else {
       throw new Error('حدث خطأ أثناء حفظ التغييرات');
}
    } catch (error) {
   this.showToast(error.message, 'error');
     this.submitBtn.disabled = false;
   this.submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>حفظ التعديلات';
    }
       }
  }

    handleKeyboard(e) {
   if (this.cropModal && this.cropModal.classList.contains('show')) {
if (e.key === 'Escape') {
       this.closeCropModal();
    }
    }
        }

  showToast(message, type = 'success') {
   const existingToasts = document.querySelectorAll('.toast-notification');
     existingToasts.forEach(toast => toast.remove());

         const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
         toast.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
 <span>${message}</span>
         <button class="btn-close" onclick="this.parentElement.remove()"></button>
       `;

     document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 4000);
            }
   }

        // Initialize
      document.addEventListener('DOMContentLoaded', function() {
         new ProfilePictureManager();

       // Smooth scrolling for navigation
   document.querySelectorAll('.quick-nav a').forEach(link => {
    link.addEventListener('click', function(e) {
     e.preventDefault();
         const targetId = this.getAttribute('href').substring(1);
   const element = document.getElementById(targetId);
        if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
         });
            });

   // Character counter for Bio
            const bioField = document.querySelector('textarea[name="Bio"]');
            if (bioField) {
             bioField.addEventListener('input', function() {
             const counter = this.parentElement.querySelector('.text-muted');
      if (counter) {
            counter.textContent = `${this.value.length} / 500 حرف`;
  }
 });
  }
        });
    </script>
}
