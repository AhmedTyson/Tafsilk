@model TafsilkPlatform.Web.ViewModels.Store.CheckoutViewModel
@{
    ViewData["Title"] = "إتمام الطلب";
}

<div class="container py-5">
    <div class="row mb-4">
 <div class="col-12">
   <h1 class="mb-3">
        <i class="fas fa-credit-card"></i> إتمام الطلب
   </h1>
     
            <!-- Progress Steps -->
    <div class="checkout-progress mb-4">
       <div class="progress" style="height: 3px;">
      <div class="progress-bar bg-success" role="progressbar" style="width: 75%"></div>
    </div>
     <div class="d-flex justify-content-between mt-2">
     <small class="text-success"><i class="fas fa-check-circle"></i> التسوق</small>
    <small class="text-success"><i class="fas fa-check-circle"></i> السلة</small>
    <small class="text-primary fw-bold"><i class="fas fa-circle"></i> الدفع</small>
          <small class="text-muted">تأكيد</small>
        </div>
    </div>
 </div>
    </div>

    <form asp-action="ProcessCheckout" method="post" id="checkoutForm">
      @Html.AntiForgeryToken()
        
 <div class="row">
   <div class="col-lg-8">
      <!-- Shipping Address -->
       <div class="card shadow-sm mb-4">
   <div class="card-header bg-primary text-white">
     <h5 class="mb-0">
     <i class="fas fa-shipping-fast"></i> عنوان الشحن
         </h5>
   </div>
         <div class="card-body">
       <div class="row g-3">
   <div class="col-md-6">
      <label for="fullName" class="form-label">الاسم الكامل <span class="text-danger">*</span></label>
      <input type="text" class="form-control" id="fullName" 
  name="ShippingAddress.FullName" 
    value="@Model.ShippingAddress.FullName" required>
    <div class="invalid-feedback">الرجاء إدخال الاسم الكامل</div>
  </div>
 
        <div class="col-md-6">
         <label for="phone" class="form-label">رقم الجوال <span class="text-danger">*</span></label>
     <div class="input-group">
        <span class="input-group-text">+966</span>
   <input type="tel" class="form-control" id="phone" 
       name="ShippingAddress.PhoneNumber" 
    value="@Model.ShippingAddress.PhoneNumber" 
       pattern="[0-9]{9}" placeholder="5xxxxxxxx" required>
           </div>
         <div class="invalid-feedback">الرجاء إدخال رقم جوال صحيح</div>
        </div>
        
      <div class="col-12">
   <label for="street" class="form-label">العنوان <span class="text-danger">*</span></label>
   <input type="text" class="form-control" id="street" 
      name="ShippingAddress.Street" 
   value="@Model.ShippingAddress.Street" 
     placeholder="الشارع، رقم المبنى، الطابق" required>
      <div class="invalid-feedback">الرجاء إدخال العنوان</div>
        </div>
       
        <div class="col-md-6">
        <label for="city" class="form-label">المدينة <span class="text-danger">*</span></label>
      <select class="form-select" id="city" name="ShippingAddress.City" required>
   <option value="">اختر المدينة</option>
     <option value="الرياض" selected="@(Model.ShippingAddress.City == "الرياض")">الرياض</option>
          <option value="جدة" selected="@(Model.ShippingAddress.City == "جدة")">جدة</option>
<option value="مكة" selected="@(Model.ShippingAddress.City == "مكة")">مكة</option>
       <option value="المدينة" selected="@(Model.ShippingAddress.City == "المدينة")">المدينة المنورة</option>
    <option value="الدمام" selected="@(Model.ShippingAddress.City == "الدمام")">الدمام</option>
    <option value="الخبر" selected="@(Model.ShippingAddress.City == "الخبر")">الخبر</option>
       <option value="الطائف" selected="@(Model.ShippingAddress.City == "الطائف")">الطائف</option>
   <option value="أخرى">أخرى</option>
       </select>
      <div class="invalid-feedback">الرجاء اختيار المدينة</div>
   </div>
       
       <div class="col-md-6">
    <label for="district" class="form-label">الحي</label>
  <input type="text" class="form-control" id="district" 
  name="ShippingAddress.District" 
    value="@Model.ShippingAddress.District">
   </div>
   
       <div class="col-md-6">
       <label for="postalCode" class="form-label">الرمز البريدي</label>
       <input type="text" class="form-control" id="postalCode" 
    name="ShippingAddress.PostalCode" 
  value="@Model.ShippingAddress.PostalCode"
      pattern="[0-9]{5}" placeholder="12345">
         </div>
      
     <div class="col-12">
          <label for="additionalInfo" class="form-label">معلومات إضافية</label>
    <textarea class="form-control" id="additionalInfo" rows="2"
       name="ShippingAddress.AdditionalInfo"
     placeholder="رقم الشقة، معلومات الوصول، إلخ...">@Model.ShippingAddress.AdditionalInfo</textarea>
      </div>
  </div>
    </div>
   </div>

      <!-- Payment Method -->
    <div class="card shadow-sm mb-4">
       <div class="card-header bg-success text-white">
      <h5 class="mb-0">
         <i class="fas fa-money-bill-wave"></i> طريقة الدفع
         </h5>
     </div>
    <div class="card-body">
    <div class="form-check mb-3 p-3 border rounded">
 <input class="form-check-input" type="radio" name="PaymentMethod" 
         id="creditCard" value="CreditCard" checked>
    <label class="form-check-label w-100" for="creditCard">
    <div class="d-flex align-items-center">
        <i class="fas fa-credit-card fa-2x text-primary me-3"></i>
         <div>
    <strong>بطاقة ائتمان/مدى</strong>
        <small class="text-muted d-block">ادفع بأمان باستخدام بطاقتك</small>
  </div>
        </div>
    </label>
 </div>
        
    <div class="form-check mb-3 p-3 border rounded">
      <input class="form-check-input" type="radio" name="PaymentMethod" 
     id="cashOnDelivery" value="CashOnDelivery">
         <label class="form-check-label w-100" for="cashOnDelivery">
       <div class="d-flex align-items-center">
     <i class="fas fa-money-bill fa-2x text-success me-3"></i>
     <div>
       <strong>الدفع عند الاستلام</strong>
         <small class="text-muted d-block">ادفع نقداً عند استلام طلبك</small>
       </div>
   </div>
      </label>
     </div>
     
     <div id="cardDetails" class="mt-4">
        <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
      <strong>وضع العرض:</strong> هذا نموذج توضيحي. لن يتم معالجة دفع فعلي.
   في الإنتاج، سيتم دمج بوابة دفع حقيقية (Stripe, PayPal, إلخ).
     </div>
     </div>
   </div>
 </div>

        <!-- Delivery Notes -->
   <div class="card shadow-sm mb-4">
         <div class="card-header">
         <h5 class="mb-0">
         <i class="fas fa-comment"></i> ملاحظات التوصيل (اختياري)
       </h5>
   </div>
         <div class="card-body">
    <textarea class="form-control" name="DeliveryNotes" rows="3"
       placeholder="أي تعليمات خاصة للتوصيل..."></textarea>
     </div>
      </div>
 </div>

   <div class="col-lg-4">
    <!-- Order Summary -->
  <div class="card shadow-sm sticky-top" style="top: 20px;">
     <div class="card-header bg-dark text-white">
  <h5 class="mb-0">
     <i class="fas fa-receipt"></i> ملخص الطلب
       </h5>
     </div>
         <div class="card-body">
      <div class="mb-3">
    <strong>المنتجات (@Model.Cart.TotalItems):</strong>
       <div class="mt-2" style="max-height: 200px; overflow-y: auto;">
        @foreach (var item in Model.Cart.Items)
          {
  <div class="d-flex justify-content-between small mt-2 pb-2 border-bottom">
   <span>
     <strong>@item.ProductName</strong>
         @if (!string.IsNullOrEmpty(item.SelectedSize))
      {
           <span class="text-muted"> (@item.SelectedSize)</span>
    }
     <br/>
       <small class="text-muted">@item.Quantity × @item.UnitPrice.ToString("N2") ريال</small>
      </span>
    <span class="fw-bold">@item.TotalPrice.ToString("N2") ريال</span>
       </div>
 }
         </div>
          </div>
          
     <hr class="my-3"/>
  
       <div class="d-flex justify-content-between mb-2">
   <span>المجموع الفرعي:</span>
    <span>@Model.Cart.SubTotal.ToString("N2") ريال</span>
 </div>
    
<div class="d-flex justify-content-between mb-2">
        <span>الشحن:</span>
     <span class="@(Model.Cart.ShippingCost == 0 ? "text-success fw-bold" : "")">
        @if (Model.Cart.ShippingCost == 0)
      {
    <text><i class="fas fa-gift"></i> مجاني</text>
       }
        else
       {
           <text>@Model.Cart.ShippingCost.ToString("N2") ريال</text>
       }
   </span>
     </div>
       
     <div class="d-flex justify-content-between mb-3">
     <span>ضريبة القيمة المضافة (15%):</span>
      <span>@Model.Cart.Tax.ToString("N2") ريال</span>
     </div>
     
        <hr class="my-3"/>
   
  <div class="d-flex justify-content-between mb-4">
    <strong class="h5">الإجمالي:</strong>
    <strong class="h4 text-primary">@Model.Cart.Total.ToString("N2") ريال</strong>
      </div>
  
         <button type="submit" class="btn btn-success btn-lg w-100 mb-2" id="submitBtn">
       <i class="fas fa-check-circle"></i> تأكيد الطلب
    </button>
       
<a asp-action="Cart" class="btn btn-outline-secondary w-100">
       <i class="fas fa-arrow-right"></i> العودة للسلة
         </a>

         <div class="mt-3">
    <div class="form-check">
    <input class="form-check-input" type="checkbox" id="agreeTerms" required>
   <label class="form-check-label small" for="agreeTerms">
     أوافق على <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">الشروط والأحكام</a>
        </label>
     </div>
       </div>

      <div class="text-center mt-3">
       <small class="text-muted">
        <i class="fas fa-lock"></i> عملية دفع آمنة ومشفرة بنسبة 100%
 </small>
    </div>
   </div>
    </div>

       <!-- Trust Badges -->
     <div class="card shadow-sm mt-3">
       <div class="card-body p-2">
        <div class="row text-center small g-2">
      <div class="col-4">
    <i class="fas fa-shield-alt text-success"></i>
    <p class="mb-0 small">آمن</p>
          </div>
       <div class="col-4">
      <i class="fas fa-truck text-primary"></i>
       <p class="mb-0 small">توصيل سريع</p>
         </div>
 <div class="col-4">
     <i class="fas fa-undo text-info"></i>
         <p class="mb-0 small">إرجاع مجاني</p>
   </div>
       </div>
    </div>
    </div>
  </div>
        </div>
 </form>
</div>

<!-- Terms Modal -->
<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
     <div class="modal-header">
        <h5 class="modal-title">الشروط والأحكام</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
   </div>
       <div class="modal-body">
      <h6>شروط الشراء والتوصيل</h6>
    <p>بالموافقة على هذه الشروط، فإنك توافق على:</p>
   <ul>
     <li>صحة المعلومات المقدمة</li>
 <li>سياسة الإرجاع والاستبدال</li>
         <li>شروط التوصيل والشحن</li>
   <li>سياسة الخصوصية</li>
       </ul>
      </div>
       <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
   </div>
 </div>
    </div>
</div>

@section Scripts {
    <script>
// ===== FORM VALIDATION =====
        (function () {
   'use strict';
   
   const checkoutForm = document.getElementById('checkoutForm');
            if (!checkoutForm) return;
       
     // Bootstrap validation
   const forms = document.querySelectorAll('.needs-validation');
         Array.prototype.slice.call(forms).forEach(function (form) {
      form.addEventListener('submit', function (event) {
              if (!form.checkValidity()) {
     event.preventDefault();
      event.stopPropagation();
   showNotification('الرجاء ملء جميع الحقول المطلوبة', 'danger');
     }
    form.classList.add('was-validated');
       }, false);
});
  })();

 // ===== PAYMENT METHOD TOGGLE =====
     function setupPaymentMethodToggle() {
  const paymentRadios = document.querySelectorAll('input[name="PaymentMethod"]');
   const cardDetails = document.getElementById('cardDetails');
    
       if (!cardDetails) return;
 
       paymentRadios.forEach(radio => {
         radio.addEventListener('change', function() {
    if (this.value === 'CreditCard') {
        cardDetails.style.display = 'block';
     cardDetails.classList.add('fade-in');
    } else {
 cardDetails.style.display = 'none';
    }
   console.log('Payment method changed to:', this.value);
    });
    });
          
       // Set initial state
    const selectedMethod = document.querySelector('input[name="PaymentMethod"]:checked');
            if (selectedMethod && selectedMethod.value !== 'CreditCard') {
    cardDetails.style.display = 'none';
       }
   }

 // ===== FORM SUBMISSION HANDLING =====
        function setupFormSubmission() {
         const checkoutForm = document.getElementById('checkoutForm');
       const submitBtn = document.getElementById('submitBtn');
      const agreeTerms = document.getElementById('agreeTerms');
       
       if (!checkoutForm || !submitBtn || !agreeTerms) return;
    
            checkoutForm.addEventListener('submit', function(e) {
         // Check terms agreement
         if (!agreeTerms.checked) {
    e.preventDefault();
 showNotification('الرجاء الموافقة على الشروط والأحكام', 'warning');
       agreeTerms.focus();
  return false;
            }
     
       // Validate required fields
      const requiredFields = checkoutForm.querySelectorAll('[required]');
    let isValid = true;
       
     requiredFields.forEach(field => {
           if (!field.value.trim()) {
  isValid = false;
     field.classList.add('is-invalid');
 }
       });
    
  if (!isValid) {
   e.preventDefault();
   showNotification('الرجاء ملء جميع الحقول المطلوبة', 'danger');
  return false;
 }
            
    // Show loading state
   submitBtn.disabled = true;
     submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>جارٍ المعالجة...';
     
      // Disable form inputs
    const inputs = checkoutForm.querySelectorAll('input, select, textarea, button');
       inputs.forEach(input => input.disabled = true);
    
    console.log('Form submitted - Processing checkout...');
    
     // Note: Form will submit naturally, server will redirect
  });
 }

    // ===== PHONE NUMBER FORMATTING =====
        function setupPhoneFormatting() {
     const phoneInput = document.getElementById('phone');
     if (!phoneInput) return;
   
    phoneInput.addEventListener('input', function(e) {
         // Remove non-digits
      let value = this.value.replace(/[^0-9]/g, '');
     
    // Limit to 9 digits (Saudi format without +966)
    if (value.length > 9) {
     value = value.substring(0, 9);
    }
         
      this.value = value;
        
     // Validate format
       if (value.length === 9) {
      this.classList.remove('is-invalid');
                this.classList.add('is-valid');
        } else if (value.length > 0) {
     this.classList.add('is-invalid');
  this.classList.remove('is-valid');
      }
   });
        
     // Validate on blur
       phoneInput.addEventListener('blur', function() {
       if (this.value.length !== 9 && this.value.length > 0) {
   showNotification('رقم الجوال يجب أن يكون 9 أرقام', 'warning');
   }
  });
        }

 // ===== POSTAL CODE VALIDATION =====
     function setupPostalCodeValidation() {
  const postalInput = document.getElementById('postalCode');
            if (!postalInput) return;
    
 postalInput.addEventListener('input', function(e) {
  // Remove non-digits
    let value = this.value.replace(/[^0-9]/g, '');
            
  // Limit to 5 digits
       if (value.length > 5) {
     value = value.substring(0, 5);
         }
     
     this.value = value;
      });
 }

 // ===== ORDER SUMMARY UPDATE =====
        function updateOrderSummary() {
      try {
      const itemsList = document.querySelectorAll('.cart-item');
      let itemCount = 0;
       let subtotal = 0;
     
 itemsList.forEach(item => {
         const quantity = parseInt(item.dataset.quantity) || 0;
          const price = parseFloat(item.dataset.price) || 0;
      itemCount += quantity;
      subtotal += (quantity * price);
          });
          
  console.log('Order summary - Items:', itemCount, 'Subtotal:', subtotal);
         } catch (error) {
   console.error('Error updating order summary:', error);
  }
     }

  // ===== NOTIFICATION HELPER =====
   function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
       notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
 notification.style.cssText = 'top: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
   notification.innerHTML = `
     <i class="fas fa-${type === 'danger' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
   ${message}
     <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
   `;
            
       document.body.appendChild(notification);
       
  // Auto-remove after 4 seconds
      setTimeout(() => {
      notification.classList.remove('show');
         setTimeout(() => notification.remove(), 300);
  }, 4000);
 }

    // ===== FIELD REAL-TIME VALIDATION =====
      function setupRealTimeValidation() {
       const requiredFields = document.querySelectorAll('[required]');
   
       requiredFields.forEach(field => {
 field.addEventListener('blur', function() {
   if (!this.value.trim()) {
       this.classList.add('is-invalid');
    } else {
        this.classList.remove('is-invalid');
        this.classList.add('is-valid');
           }
       });
          
     field.addEventListener('input', function() {
        if (this.classList.contains('is-invalid') && this.value.trim()) {
   this.classList.remove('is-invalid');
    this.classList.add('is-valid');
      }
    });
     });
 }

        // ===== CART ITEMS VALIDATION =====
        function validateCartItems() {
      const itemsContainer = document.querySelector('.cart-items-container');
            if (!itemsContainer) return true;
    
            const items = itemsContainer.querySelectorAll('.cart-item');
        if (items.length === 0) {
  showNotification('سلة التسوق فارغة', 'warning');
      setTimeout(() => {
   window.location.href = '@Url.Action("Cart", "Store")';
    }, 1500);
    return false;
            }
     
    return true;
        }

  // ===== SAVE CHECKOUT DATA TO LOCALSTORAGE =====
        function saveCheckoutData() {
       const form = document.getElementById('checkoutForm');
  if (!form) return;
   
            const formData = new FormData(form);
       const data = {};
    
            formData.forEach((value, key) => {
   if (!key.includes('PaymentMethod') && !key.includes('__RequestVerificationToken')) {
         data[key] = value;
     }
     });
     
    localStorage.setItem('tafsilk_checkout_data', JSON.stringify(data));
 console.log('Checkout data saved to localStorage');
     }

  // ===== RESTORE CHECKOUT DATA FROM LOCALSTORAGE =====
        function restoreCheckoutData() {
const savedData = localStorage.getItem('tafsilk_checkout_data');
         if (!savedData) return;
    
       try {
         const data = JSON.parse(savedData);
         
        Object.keys(data).forEach(key => {
   const field = document.querySelector(`[name="${key}"]`);
   if (field && !field.value) {
             field.value = data[key];
    }
     });
            
  console.log('Checkout data restored from localStorage');
       } catch (error) {
   console.error('Error restoring checkout data:', error);
     }
  }

  // ===== INITIALIZE ON PAGE LOAD =====
    document.addEventListener('DOMContentLoaded', function() {
   console.log('Checkout page loaded - Initializing...');
   
     // Validate cart has items
      validateCartItems();
    
          // Setup all handlers
     setupPaymentMethodToggle();
    setupFormSubmission();
   setupPhoneFormatting();
    setupPostalCodeValidation();
setupRealTimeValidation();
  
  // Restore saved data
       restoreCheckoutData();
  
   // Update order summary
  updateOrderSummary();
            
       // Save data on input
 const form = document.getElementById('checkoutForm');
          if (form) {
 form.addEventListener('input', debounce(saveCheckoutData, 1000));
 }
  
    // Log cart items
   const cartItems = document.querySelectorAll('.cart-item');
     console.log('Checkout - Cart items:', cartItems.length);
      
    // Focus first empty required field
       const firstEmptyField = document.querySelector('[required]:not([value])');
      if (firstEmptyField) {
     firstEmptyField.focus();
            }
  
            console.log('Checkout initialization complete!');
        });

  // ===== DEBOUNCE HELPER =====
        function debounce(func, wait) {
            let timeout;
       return function executedFunction(...args) {
     const later = () => {
      clearTimeout(timeout);
       func(...args);
         };
clearTimeout(timeout);
   timeout = setTimeout(later, wait);
      };
        }

// ===== HANDLE PAGE BEFORE UNLOAD =====
        window.addEventListener('beforeunload', function() {
 const form = document.getElementById('checkoutForm');
     const submitBtn = document.getElementById('submitBtn');
     
          // Only warn if form is being filled but not submitted
   if (form && !submitBtn.disabled) {
         const filledFields = Array.from(form.querySelectorAll('input, select, textarea'))
   .filter(field => field.value && field.value.trim() !== '');
     
    if (filledFields.length > 3) {
     // User has filled some fields
           // return 'لديك بيانات غير محفوظة. هل تريد المغادرة؟';
   }
      }
   });

 // ===== ADD ANIMATION STYLES =====
 const style = document.createElement('style');
        style.textContent = `
   .fade-in {
       animation: fadeIn 0.3s ease-in;
   }
       
      @@keyframes fadeIn {
 from { opacity: 0; transform: translateY(-10px); }
     to { opacity: 1; transform: translateY(0); }
       }
       
      .is-invalid {
    border-color: #dc3545 !important;
   }
   
     .is-valid {
        border-color: #198754 !important;
      }
        `;
        document.head.appendChild(style);
     
        console.log('Checkout scripts loaded successfully');
    </script>
}
